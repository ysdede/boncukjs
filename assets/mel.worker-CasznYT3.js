const I={SAMPLE_RATE:16e3,N_FFT:512,WIN_LENGTH:400,HOP_LENGTH:160,PREEMPH:.97,LOG_ZERO_GUARD:5960464477539063e-23,N_FREQ_BINS:257},O=200/3,L=1e3,x=L/O,D=Math.log(6.4)/27;function k(t){return t>=L?x+Math.log(t/L)/D:t/O}function Z(t){return t>=x?L*Math.exp(D*(t-x)):t*O}function j(t){const{SAMPLE_RATE:a,N_FREQ_BINS:r}=I,n=a/2,e=new Float64Array(r);for(let l=0;l<r;l++)e[l]=n*l/(r-1);const c=k(0),i=k(n),s=t+2,f=new Float64Array(s);for(let l=0;l<s;l++)f[l]=Z(c+(i-c)*l/(s-1));const m=new Float64Array(s-1);for(let l=0;l<s-1;l++)m[l]=f[l+1]-f[l];const o=new Float32Array(t*r);for(let l=0;l<t;l++){const _=2/(f[l+2]-f[l]),M=l*r;for(let y=0;y<r;y++){const C=(e[y]-f[l])/m[l],Q=(f[l+2]-e[y])/m[l+1];o[M+y]=Math.max(0,Math.min(C,Q))*_}}return o}function V(){const{N_FFT:t,WIN_LENGTH:a}=I,r=new Float64Array(t),n=t-a>>1;for(let e=0;e<a;e++)r[n+e]=.5*(1-Math.cos(2*Math.PI*e/(a-1)));return r}function q(t){const a=t>>1,r=new Float64Array(a),n=new Float64Array(a);for(let e=0;e<a;e++){const c=-2*Math.PI*e/t;r[e]=Math.cos(c),n[e]=Math.sin(c)}return{cos:r,sin:n}}function J(t,a,r,n){for(let e=1,c=0;e<r;e++){let i=r>>1;for(;c&i;)c^=i,i>>=1;if(c^=i,e<c){let s=t[e];t[e]=t[c],t[c]=s,s=a[e],a[e]=a[c],a[c]=s}}for(let e=2;e<=r;e<<=1){const c=e>>1,i=r/e;for(let s=0;s<r;s+=e)for(let f=0;f<c;f++){const m=f*i,o=t[s+f+c]*n.cos[m]-a[s+f+c]*n.sin[m],l=t[s+f+c]*n.sin[m]+a[s+f+c]*n.cos[m];t[s+f+c]=t[s+f]-o,a[s+f+c]=a[s+f]-l,t[s+f]+=o,a[s+f]+=l}}}function K(t,a,r){const n=new Float32Array(t.length);for(let e=0;e<a;e++){const c=e*r;let i=0;for(let o=0;o<r;o++)n[c+o]=t[c+o],i+=t[c+o];const s=i/r;let f=0;for(let o=0;o<r;o++){const l=n[c+o]-s;f+=l*l}const m=r>1?1/(Math.sqrt(f/(r-1))+1e-5):0;for(let o=0;o<r;o++)n[c+o]=(n[c+o]-s)*m}return n}function P(t){return Math.floor(t/I.HOP_LENGTH)}const{N_FFT:w,HOP_LENGTH:$,N_FREQ_BINS:R,PREEMPH:B,LOG_ZERO_GUARD:X}=I;let d=128,E=new Float32Array(0),h=0,F=0,b=0,g=0,A=null,u=0,p=0,T=0,S,N,G,U,z,v,W=0;const Y=5e3;function ee(t){const a=performance.now();d=t.nMels||128,U=j(d),z=V(),v=q(w),S=new Float64Array(w),N=new Float64Array(w),G=new Float32Array(R),u=12e3,A=new Float32Array(d*u),p=0,T=0,E=new Float32Array(w+16e3),h=0,F=0,b=0,g=0;const r=(d*u*4/1024/1024).toFixed(1);console.log(`[MelWorker] Initialized: nMels=${d}, maxFrames=${u} (circular), ${r}MB mel buffer, preemph=${E.length} samples, init ${(performance.now()-a).toFixed(1)} ms`)}function te(t){if(!A)return;const a=t.length;if(a===0)return;const r=performance.now();if(F+a>E.length){const s=Math.max(E.length*2,F+a),f=new Float32Array(s);f.set(E.subarray(0,F)),E=f}E[F]=t[0]-B*b;for(let s=1;s<a;s++)E[F+s]=t[s]-B*t[s-1];F+=a,b=t[a-1],g+=a;const n=Math.floor(g/$);if(n<=p){H();return}const e=w>>1;for(let s=p;s<n;s++){const f=s*$-e,m=s%u;for(let o=0;o<w;o++){const _=f+o-h,M=_>=0&&_<F?E[_]:0;S[o]=M*z[o],N[o]=0}J(S,N,w,v);for(let o=0;o<R;o++)G[o]=S[o]*S[o]+N[o]*N[o];for(let o=0;o<d;o++){let l=0;const _=o*R;for(let M=0;M<R;M++)l+=G[M]*U[_+M];A[o*u+m]=Math.log(l+X)}}const c=p;p=n,p-T>u&&(T=p-u),H();const i=n-c;if(i>0){const s=performance.now()-r;p%50<i&&console.log(`[MelWorker] pushAudio: +${a} samples, +${i} frames, total ${p} frames (${(g/16e3).toFixed(1)}s), buf [${T}..${p}), preemph ${F} samples, ${s.toFixed(1)} ms`)}}function H(){const t=w>>1,a=p*$-t,r=Math.max(0,a),n=r-h;if(n>0&&n<F){const e=F-n;E.copyWithin(0,n,n+e),F=e,h=r}else n>=F&&(F=0,h=r)}function oe(t,a,r=!0){const n=performance.now();if(!A||p===0)return console.warn(`[MelWorker] getFeatures: no data (computedFrames=${p})`),null;const e=Math.max(T,t),c=Math.min(p,a),i=c-e;if(i<=0)return console.warn(`[MelWorker] getFeatures: empty range (requested ${t}..${a}, available ${T}..${p})`),null;const s=new Float32Array(d*i);for(let o=0;o<d;o++){const l=o*u,_=o*i;for(let M=0;M<i;M++){const y=(e+M)%u;s[_+M]=A[l+y]}}const f=r?K(s,d,i):s,m=performance.now();if(m-W>Y){W=m;const o=m-n;console.log(`[MelWorker] getFeatures: frames ${e}..${c} (${i} frames, ${(i*$/16e3).toFixed(2)}s), normalize=${r}, ${o.toFixed(1)} ms, buf [${T}..${p})`)}return{features:f,T:i,melBins:d}}function ne(){if(!A||p===0)return null;const t=new Float32Array(d),a=(p-1+u)%u,r=p>=2?(p-2+u)%u:a;for(let n=0;n<d;n++){const e=n*u;t[n]=.5*(A[e+a]+A[e+r])}return t}function se(){F=0,h=0,b=0,g=0,p=0,T=0,console.log("[MelWorker] Reset")}self.onmessage=t=>{const{type:a,payload:r,id:n}=t.data;try{switch(a){case"INIT":{ee(r||{}),postMessage({type:"INIT_DONE",id:n});break}case"PUSH_AUDIO":{te(r);break}case"GET_FEATURES":{const{startSample:e,endSample:c,normalize:i=!0}=r,s=P(e),f=P(c),m=oe(s,f,i);m?postMessage({type:"GET_FEATURES_DONE",payload:m,id:n},[m.features.buffer]):postMessage({type:"GET_FEATURES_DONE",payload:null,id:n});break}case"GET_STATUS":{postMessage({type:"GET_STATUS_DONE",payload:{totalSamples:g,computedFrames:p,bufferCapacityFrames:u,melBins:d},id:n});break}case"GET_LAST_MEL_FRAME":{const e=ne();e?postMessage({type:"GET_LAST_MEL_FRAME_DONE",payload:{melFrame:e},id:n},[e.buffer]):postMessage({type:"GET_LAST_MEL_FRAME_DONE",payload:null,id:n});break}case"RESET":{se(),postMessage({type:"RESET_DONE",id:n});break}default:console.warn("[MelWorker] Unknown message type:",a)}}catch(e){console.error("[MelWorker] Error:",e),postMessage({type:"ERROR",payload:e.message,id:n})}};console.log("[MelWorker] Worker script loaded");
