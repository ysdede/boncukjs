(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const xr=!1,wr=(r,e)=>r===e,At=Symbol("solid-proxy"),Cr=typeof Proxy=="function",$r=Symbol("solid-track"),ft={equals:wr};let Yt=Qt;const Be=1,gt=2,Zt={owned:null,cleanups:null,context:null,owner:null};var fe=null;let wt=null,_r=null,he=null,be=null,Ie=null,yt=0;function Xe(r,e){const t=he,s=fe,i=r.length===0,n=e===void 0?s:e,a=i?Zt:{owned:null,cleanups:null,context:n?n.context:null,owner:n},o=i?r:()=>r(()=>Le(()=>Je(a)));fe=a,he=null;try{return tt(o,!0)}finally{he=t,fe=s}}function M(r,e){e=e?Object.assign({},ft,e):ft;const t={value:r,observers:null,observerSlots:null,comparator:e.equals||void 0},s=i=>(typeof i=="function"&&(i=i(t.value)),Xt(t,i));return[Kt.bind(t),s]}function ee(r,e,t){const s=It(r,e,!1,Be);et(s)}function Qe(r,e,t){Yt=Er;const s=It(r,e,!1,Be);s.user=!0,Ie?Ie.push(s):et(s)}function De(r,e,t){t=t?Object.assign({},ft,t):ft;const s=It(r,e,!0,0);return s.observers=null,s.observerSlots=null,s.comparator=t.equals||void 0,et(s),Kt.bind(s)}function Le(r){if(he===null)return r();const e=he;he=null;try{return r()}finally{he=e}}function bt(r){Qe(()=>Le(r))}function Oe(r){return fe===null||(fe.cleanups===null?fe.cleanups=[r]:fe.cleanups.push(r)),r}function Kt(){if(this.sources&&this.state)if(this.state===Be)et(this);else{const r=be;be=null,tt(()=>mt(this),!1),be=r}if(he){const r=this.observers?this.observers.length:0;he.sources?(he.sources.push(this),he.sourceSlots.push(r)):(he.sources=[this],he.sourceSlots=[r]),this.observers?(this.observers.push(he),this.observerSlots.push(he.sources.length-1)):(this.observers=[he],this.observerSlots=[he.sources.length-1])}return this.value}function Xt(r,e,t){let s=r.value;return(!r.comparator||!r.comparator(s,e))&&(r.value=e,r.observers&&r.observers.length&&tt(()=>{for(let i=0;i<r.observers.length;i+=1){const n=r.observers[i],a=wt&&wt.running;a&&wt.disposed.has(n),(a?!n.tState:!n.state)&&(n.pure?be.push(n):Ie.push(n),n.observers&&Jt(n)),a||(n.state=Be)}if(be.length>1e6)throw be=[],new Error},!1)),e}function et(r){if(!r.fn)return;Je(r);const e=yt;Tr(r,r.value,e)}function Tr(r,e,t){let s;const i=fe,n=he;he=fe=r;try{s=r.fn(e)}catch(a){return r.pure&&(r.state=Be,r.owned&&r.owned.forEach(Je),r.owned=null),r.updatedAt=t+1,er(a)}finally{he=n,fe=i}(!r.updatedAt||r.updatedAt<=t)&&(r.updatedAt!=null&&"observers"in r?Xt(r,s):r.value=s,r.updatedAt=t)}function It(r,e,t,s=Be,i){const n={fn:r,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:fe,context:fe?fe.context:null,pure:t};return fe===null||fe!==Zt&&(fe.owned?fe.owned.push(n):fe.owned=[n]),n}function pt(r){if(r.state===0)return;if(r.state===gt)return mt(r);if(r.suspense&&Le(r.suspense.inFallback))return r.suspense.effects.push(r);const e=[r];for(;(r=r.owner)&&(!r.updatedAt||r.updatedAt<yt);)r.state&&e.push(r);for(let t=e.length-1;t>=0;t--)if(r=e[t],r.state===Be)et(r);else if(r.state===gt){const s=be;be=null,tt(()=>mt(r,e[0]),!1),be=s}}function tt(r,e){if(be)return r();let t=!1;e||(be=[]),Ie?t=!0:Ie=[],yt++;try{const s=r();return kr(t),s}catch(s){t||(Ie=null),be=null,er(s)}}function kr(r){if(be&&(Qt(be),be=null),r)return;const e=Ie;Ie=null,e.length&&tt(()=>Yt(e),!1)}function Qt(r){for(let e=0;e<r.length;e++)pt(r[e])}function Er(r){let e,t=0;for(e=0;e<r.length;e++){const s=r[e];s.user?r[t++]=s:pt(s)}for(e=0;e<t;e++)pt(r[e])}function mt(r,e){r.state=0;for(let t=0;t<r.sources.length;t+=1){const s=r.sources[t];if(s.sources){const i=s.state;i===Be?s!==e&&(!s.updatedAt||s.updatedAt<yt)&&pt(s):i===gt&&mt(s,e)}}}function Jt(r){for(let e=0;e<r.observers.length;e+=1){const t=r.observers[e];t.state||(t.state=gt,t.pure?be.push(t):Ie.push(t),t.observers&&Jt(t))}}function Je(r){let e;if(r.sources)for(;r.sources.length;){const t=r.sources.pop(),s=r.sourceSlots.pop(),i=t.observers;if(i&&i.length){const n=i.pop(),a=t.observerSlots.pop();s<i.length&&(n.sourceSlots[a]=s,i[s]=n,t.observerSlots[s]=a)}}if(r.tOwned){for(e=r.tOwned.length-1;e>=0;e--)Je(r.tOwned[e]);delete r.tOwned}if(r.owned){for(e=r.owned.length-1;e>=0;e--)Je(r.owned[e]);r.owned=null}if(r.cleanups){for(e=r.cleanups.length-1;e>=0;e--)r.cleanups[e]();r.cleanups=null}r.state=0}function Mr(r){return r instanceof Error?r:new Error(typeof r=="string"?r:"Unknown error",{cause:r})}function er(r,e=fe){throw Mr(r)}const Rr=Symbol("fallback");function Lt(r){for(let e=0;e<r.length;e++)r[e]()}function Fr(r,e,t={}){let s=[],i=[],n=[],a=0,o=e.length>1?[]:null;return Oe(()=>Lt(n)),()=>{let c=r()||[],h=c.length,u,d;return c[$r],Le(()=>{let p,k,_,E,x,S,y,z,R;if(h===0)a!==0&&(Lt(n),n=[],s=[],i=[],a=0,o&&(o=[])),t.fallback&&(s=[Rr],i[0]=Xe(G=>(n[0]=G,t.fallback())),a=1);else if(a===0){for(i=new Array(h),d=0;d<h;d++)s[d]=c[d],i[d]=Xe(m);a=h}else{for(_=new Array(h),E=new Array(h),o&&(x=new Array(h)),S=0,y=Math.min(a,h);S<y&&s[S]===c[S];S++);for(y=a-1,z=h-1;y>=S&&z>=S&&s[y]===c[z];y--,z--)_[z]=i[y],E[z]=n[y],o&&(x[z]=o[y]);for(p=new Map,k=new Array(z+1),d=z;d>=S;d--)R=c[d],u=p.get(R),k[d]=u===void 0?-1:u,p.set(R,d);for(u=S;u<=y;u++)R=s[u],d=p.get(R),d!==void 0&&d!==-1?(_[d]=i[u],E[d]=n[u],o&&(x[d]=o[u]),d=k[d],p.set(R,d)):n[u]();for(d=S;d<h;d++)d in _?(i[d]=_[d],n[d]=E[d],o&&(o[d]=x[d],o[d](d))):i[d]=Xe(m);i=i.slice(0,a=h),s=c.slice(0)}return i});function m(p){if(n[d]=p,o){const[k,_]=M(d);return o[d]=_,e(c[d],k)}return e(c[d])}}}function F(r,e){return Le(()=>r(e||{}))}function nt(){return!0}const Ar={get(r,e,t){return e===At?t:r.get(e)},has(r,e){return e===At?!0:r.has(e)},set:nt,deleteProperty:nt,getOwnPropertyDescriptor(r,e){return{configurable:!0,enumerable:!0,get(){return r.get(e)},set:nt,deleteProperty:nt}},ownKeys(r){return r.keys()}};function Ct(r){return(r=typeof r=="function"?r():r)?r:{}}function Dr(){for(let r=0,e=this.length;r<e;++r){const t=this[r]();if(t!==void 0)return t}}function Ir(...r){let e=!1;for(let a=0;a<r.length;a++){const o=r[a];e=e||!!o&&At in o,r[a]=typeof o=="function"?(e=!0,De(o)):o}if(Cr&&e)return new Proxy({get(a){for(let o=r.length-1;o>=0;o--){const c=Ct(r[o])[a];if(c!==void 0)return c}},has(a){for(let o=r.length-1;o>=0;o--)if(a in Ct(r[o]))return!0;return!1},keys(){const a=[];for(let o=0;o<r.length;o++)a.push(...Object.keys(Ct(r[o])));return[...new Set(a)]}},Ar);const t={},s=Object.create(null);for(let a=r.length-1;a>=0;a--){const o=r[a];if(!o)continue;const c=Object.getOwnPropertyNames(o);for(let h=c.length-1;h>=0;h--){const u=c[h];if(u==="__proto__"||u==="constructor")continue;const d=Object.getOwnPropertyDescriptor(o,u);if(!s[u])s[u]=d.get?{enumerable:!0,configurable:!0,get:Dr.bind(t[u]=[d.get.bind(o)])}:d.value!==void 0?d:void 0;else{const m=t[u];m&&(d.get?m.push(d.get.bind(o)):d.value!==void 0&&m.push(()=>d.value))}}}const i={},n=Object.keys(s);for(let a=n.length-1;a>=0;a--){const o=n[a],c=s[o];c&&c.get?Object.defineProperty(i,o,c):i[o]=c?c.value:void 0}return i}const Pr=r=>`Stale read from <${r}>.`;function je(r){const e="fallback"in r&&{fallback:()=>r.fallback};return De(Fr(()=>r.each,r.children,e||void 0))}function Z(r){const e=r.keyed,t=De(()=>r.when,void 0,void 0),s=e?t:De(t,void 0,{equals:(i,n)=>!i==!n});return De(()=>{const i=s();if(i){const n=r.children;return typeof n=="function"&&n.length>0?Le(()=>n(e?i:()=>{if(!Le(s))throw Pr("Show");return t()})):n}return r.fallback},void 0,void 0)}const Te=r=>De(()=>r());function Lr(r,e,t){let s=t.length,i=e.length,n=s,a=0,o=0,c=e[i-1].nextSibling,h=null;for(;a<i||o<n;){if(e[a]===t[o]){a++,o++;continue}for(;e[i-1]===t[n-1];)i--,n--;if(i===a){const u=n<s?o?t[o-1].nextSibling:t[n-o]:c;for(;o<n;)r.insertBefore(t[o++],u)}else if(n===o)for(;a<i;)(!h||!h.has(e[a]))&&e[a].remove(),a++;else if(e[a]===t[n-1]&&t[o]===e[i-1]){const u=e[--i].nextSibling;r.insertBefore(t[o++],e[a++].nextSibling),r.insertBefore(t[--n],u),e[i]=t[n]}else{if(!h){h=new Map;let d=o;for(;d<n;)h.set(t[d],d++)}const u=h.get(e[a]);if(u!=null)if(o<u&&u<n){let d=a,m=1,p;for(;++d<i&&d<n&&!((p=h.get(e[d]))==null||p!==u+m);)m++;if(m>u-o){const k=e[a];for(;o<u;)r.insertBefore(t[o++],k)}else r.replaceChild(t[o++],e[a++])}else a++;else e[a++].remove()}}}const Bt="_$DX_DELEGATE";function Br(r,e,t,s={}){let i;return Xe(n=>{i=n,e===document?r():f(e,r(),e.firstChild?null:void 0,t)},s.owner),()=>{i(),e.textContent=""}}function $(r,e,t,s){let i;const n=()=>{const o=document.createElement("template");return o.innerHTML=r,o.content.firstChild},a=()=>(i||(i=n())).cloneNode(!0);return a.cloneNode=a,a}function Ge(r,e=window.document){const t=e[Bt]||(e[Bt]=new Set);for(let s=0,i=r.length;s<i;s++){const n=r[s];t.has(n)||(t.add(n),e.addEventListener(n,Nr))}}function qe(r,e,t){t==null?r.removeAttribute(e):r.setAttribute(e,t)}function oe(r,e){e==null?r.removeAttribute("class"):r.className=e}function tr(r,e,t,s){Array.isArray(t)?(r[`$$${e}`]=t[0],r[`$$${e}Data`]=t[1]):r[`$$${e}`]=t}function zr(r,e,t={}){const s=Object.keys(e||{}),i=Object.keys(t);let n,a;for(n=0,a=i.length;n<a;n++){const o=i[n];!o||o==="undefined"||e[o]||(zt(r,o,!1),delete t[o])}for(n=0,a=s.length;n<a;n++){const o=s[n],c=!!e[o];!o||o==="undefined"||t[o]===c||!c||(zt(r,o,!0),t[o]=c)}return t}function Vr(r,e,t){if(!e)return t?qe(r,"style"):e;const s=r.style;if(typeof e=="string")return s.cssText=e;typeof t=="string"&&(s.cssText=t=void 0),t||(t={}),e||(e={});let i,n;for(n in t)e[n]==null&&s.removeProperty(n),delete t[n];for(n in e)i=e[n],i!==t[n]&&(s.setProperty(n,i),t[n]=i);return t}function Ce(r,e,t){t!=null?r.style.setProperty(e,t):r.style.removeProperty(e)}function rt(r,e,t){return Le(()=>r(e,t))}function f(r,e,t,s){if(t!==void 0&&!s&&(s=[]),typeof e!="function")return vt(r,e,s,t);ee(i=>vt(r,e(),i,t),s)}function zt(r,e,t){const s=e.trim().split(/\s+/);for(let i=0,n=s.length;i<n;i++)r.classList.toggle(s[i],t)}function Nr(r){let e=r.target;const t=`$$${r.type}`,s=r.target,i=r.currentTarget,n=c=>Object.defineProperty(r,"target",{configurable:!0,value:c}),a=()=>{const c=e[t];if(c&&!e.disabled){const h=e[`${t}Data`];if(h!==void 0?c.call(e,h,r):c.call(e,r),r.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(r.target)&&n(e.host),!0},o=()=>{for(;a()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(r,"currentTarget",{configurable:!0,get(){return e||document}}),r.composedPath){const c=r.composedPath();n(c[0]);for(let h=0;h<c.length-2&&(e=c[h],!!a());h++){if(e._$host){e=e._$host,o();break}if(e.parentNode===i)break}}else o();n(s)}function vt(r,e,t,s,i){for(;typeof t=="function";)t=t();if(e===t)return t;const n=typeof e,a=s!==void 0;if(r=a&&t[0]&&t[0].parentNode||r,n==="string"||n==="number"){if(n==="number"&&(e=e.toString(),e===t))return t;if(a){let o=t[0];o&&o.nodeType===3?o.data!==e&&(o.data=e):o=document.createTextNode(e),t=He(r,t,s,o)}else t!==""&&typeof t=="string"?t=r.firstChild.data=e:t=r.textContent=e}else if(e==null||n==="boolean")t=He(r,t,s);else{if(n==="function")return ee(()=>{let o=e();for(;typeof o=="function";)o=o();t=vt(r,o,t,s)}),()=>t;if(Array.isArray(e)){const o=[],c=t&&Array.isArray(t);if(Dt(o,e,t,i))return ee(()=>t=vt(r,o,t,s,!0)),()=>t;if(o.length===0){if(t=He(r,t,s),a)return t}else c?t.length===0?Vt(r,o,s):Lr(r,t,o):(t&&He(r),Vt(r,o));t=o}else if(e.nodeType){if(Array.isArray(t)){if(a)return t=He(r,t,s,e);He(r,t,null,e)}else t==null||t===""||!r.firstChild?r.appendChild(e):r.replaceChild(e,r.firstChild);t=e}}return t}function Dt(r,e,t,s){let i=!1;for(let n=0,a=e.length;n<a;n++){let o=e[n],c=t&&t[r.length],h;if(!(o==null||o===!0||o===!1))if((h=typeof o)=="object"&&o.nodeType)r.push(o);else if(Array.isArray(o))i=Dt(r,o,c)||i;else if(h==="function")if(s){for(;typeof o=="function";)o=o();i=Dt(r,Array.isArray(o)?o:[o],Array.isArray(c)?c:[c])||i}else r.push(o),i=!0;else{const u=String(o);c&&c.nodeType===3&&c.data===u?r.push(c):r.push(document.createTextNode(u))}}return i}function Vt(r,e,t=null){for(let s=0,i=e.length;s<i;s++)r.insertBefore(e[s],t)}function He(r,e,t,s){if(t===void 0)return r.textContent="";const i=s||document.createTextNode("");if(e.length){let n=!1;for(let a=e.length-1;a>=0;a--){const o=e[a];if(i!==o){const c=o.parentNode===r;!n&&!a?c?r.replaceChild(i,o):r.insertBefore(i,t):c&&o.remove()}else n=!0}}else r.insertBefore(i,t);return[i]}function Or(){const[r,e]=M("idle"),[t,s]=M(0),[i,n]=M([]),[a,o]=M("");let c;const[h,u]=M("unloaded"),[d,m]=M("parakeet-tdt-0.6b-v2"),[p,k]=M(0),[_,E]=M(""),[x,S]=M(""),[y,z]=M("webgpu"),[R,G]=M(null),[X,J]=M(""),[ce,ge]=M(""),[ye,C]=M(0),[P,L]=M(new Float32Array(0)),[H,Q]=M(!1),[v,T]=M(!1),[j,b]=M(typeof navigator<"u"?navigator.onLine:!0),[w,q]=M(0),[I,B]=M([]),A=5,te=le=>{q(le),B(pe=>[...pe.slice(1-A),le])},O=De(()=>{const le=I();return le.length===0?w():le.reduce((pe,Ye)=>pe+Ye,0)/le.length}),[ue,V]=M([]),[Se,ke]=M({throughput:0,modelConfidence:0}),[_e,We]=M("v4-utterance"),[ze,Re]=M({lcsLength:0,anchorValid:!1,chunkCount:0,anchorTokens:[]}),[xe,Ve]=M(0),[Fe,Pe]=M([]),g=10,N=le=>{Ve(le),Pe(pe=>[...pe.slice(1-g),le])},D=De(()=>{const le=Fe().filter(pe=>pe>0);return le.length===0?0:le.reduce((pe,Ye)=>pe+1/Ye,0)/le.length}),[W,U]=M({fillRatio:0,latencyMs:0}),[Y,ie]=M(5),[ae,K]=M(3.5),[se,we]=M(1.5),[Ee,$e]=M(.08),[Ue,st]=M(1),[St,it]=M(480),[xt,or]=M(1),[ar,lr]=M(.5),[cr,dr]=M(!1),[hr,ur]=M(""),[fr,gr]=M(""),[pr,mr]=M(0),[vr,yr]=M({isSpeech:!1,energy:0,snr:0,sileroProbability:0,hybridState:"silence"}),[br,Sr]=M({sentencesFinalized:0,cursorUpdates:0,utterancesProcessed:0});if(typeof window<"u"){const le=()=>b(!0),pe=()=>b(!1);window.addEventListener("online",le),window.addEventListener("offline",pe),Oe(()=>{window.removeEventListener("online",le),window.removeEventListener("offline",pe)})}return{recordingState:r,availableDevices:i,selectedDeviceId:a,sessionDuration:t,modelState:h,selectedModelId:d,modelProgress:p,modelMessage:_,modelFile:x,backend:y,transcript:X,pendingText:ce,audioLevel:ye,barLevels:P,setBarLevels:L,isSpeechDetected:H,isOfflineReady:v,isOnline:j,inferenceLatency:w,inferenceLatencyAverage:O,rtf:xe,rtfxAverage:D,bufferMetrics:W,debugTokens:ue,systemMetrics:Se,errorMessage:R,transcriptionMode:_e,mergeInfo:ze,streamingWindow:Y,streamingOverlap:ae,triggerInterval:se,energyThreshold:Ee,frameStride:Ue,v4InferenceIntervalMs:St,v4SilenceFlushSec:xt,sileroThreshold:ar,showDebugPanel:cr,matureText:hr,immatureText:fr,matureCursorTime:pr,vadState:vr,v4MergerStats:br,setRecordingState:e,setSessionDuration:s,setAvailableDevices:n,setSelectedDeviceId:o,setModelState:u,setSelectedModelId:m,setModelProgress:k,setModelMessage:E,setModelFile:S,setBackend:z,setErrorMessage:G,setTranscript:J,setPendingText:ge,setAudioLevel:C,setIsSpeechDetected:Q,setIsOfflineReady:T,setInferenceLatency:te,setRtf:N,setBufferMetrics:U,setDebugTokens:V,setSystemMetrics:ke,setTranscriptionMode:We,setMergeInfo:Re,setStreamingWindow:ie,setStreamingOverlap:K,setTriggerInterval:we,setEnergyThreshold:$e,setFrameStride:st,setShowDebugPanel:dr,setV4InferenceIntervalMs:it,setV4SilenceFlushSec:or,setSileroThreshold:lr,setMatureText:ur,setImmatureText:gr,setMatureCursorTime:mr,setVadState:yr,setV4MergerStats:Sr,startRecording:()=>{e("recording"),s(0),c&&clearInterval(c),c=window.setInterval(()=>{s(le=>le+1)},1e3)},stopRecording:()=>{e("idle"),c&&(clearInterval(c),c=void 0)},refreshDevices:async()=>{try{const pe=(await navigator.mediaDevices.enumerateDevices()).filter(Ye=>Ye.kind==="audioinput");n(pe),pe.length>0&&!a()&&o(pe[0].deviceId)}catch(le){console.error("Failed to enum devices:",le)}},appendTranscript:le=>{J(pe=>pe+le),ge("")},clearTranscript:()=>{J(""),ge("")},copyTranscript:async()=>{try{return await navigator.clipboard.writeText(X()),!0}catch{return!1}}}}const l=Xe(Or),rr=-11,Wr=0,Ur=Wr-rr;function Hr(r){const e=(r-rr)/Ur;return Math.max(0,Math.min(1,e))}var jr=$('<div class="relative w-full bg-slate-900 rounded border border-slate-700 overflow-hidden shadow-inner"><canvas class="w-full h-full block"></canvas><div class="absolute top-2 left-2 text-[10px] text-slate-400 pointer-events-none">SPECTROGRAM + WAVEFORM (<!>s)');const $t=(()=>{const r=[[0,0,0,0],[.12,0,0,180],[.3,120,0,160],[.48,0,180,80],[.65,220,220,0],[.82,255,140,0],[1,255,0,0]],e=new Uint8Array(256*3);for(let t=0;t<256;t++){const s=t/255;let i=0,n=0,a=0;for(let c=0;c<r.length-1;c++){const[h,u,d,m]=r[c],[p,k,_,E]=r[c+1];if(s>=h&&s<=p){const x=(s-h)/(p-h);i=Math.round(u+x*(k-u)),n=Math.round(d+x*(_-d)),a=Math.round(m+x*(E-m));break}}if(s>=r[r.length-1][0]){const c=r[r.length-1];i=c[1],n=c[2],a=c[3]}const o=t*3;e[o]=i,e[o+1]=n,e[o+2]=a}return e})(),qr=r=>{let e,t=null,s;const i=()=>r.windowDuration||8;let n,a=null,o=0;const c=100,h=33;let u=0,d=0,m=0,p=window.devicePixelRatio||1,k=null,_=null;const E=(C,P)=>{p=window.devicePixelRatio||1,d=Math.floor(C*p),m=Math.floor(P*p),e&&(e.width!==d||e.height!==m)&&(e.width=d,e.height=m),n&&(n.width!==d||n.height!==m)&&(n.width=d,n.height=m)};let x=null,S=0,y=0,z=null,R=null;bt(()=>{if(e){t=e.getContext("2d",{alpha:!1}),k=new ResizeObserver(L=>{for(const H of L){const Q=H.contentRect;E(Q.width,Q.height)}}),k.observe(e);const C=()=>{_=window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);const L=()=>{if(e){const H=e.getBoundingClientRect();E(H.width,H.height)}C()};_.addEventListener("change",L,{once:!0})};C();const P=e.getBoundingClientRect();E(P.width,P.height)}n=document.createElement("canvas"),a=n.getContext("2d",{alpha:!1}),G()}),Oe(()=>{cancelAnimationFrame(s),k&&(k.disconnect(),k=null)});const G=(C=performance.now())=>{if(!t||!e||!r.audioEngine){s=requestAnimationFrame(G);return}if(C-u<h){s=requestAnimationFrame(G);return}u=C;const P=p,L=d,H=m;if(L===0||H===0){s=requestAnimationFrame(G);return}const Q="#0f172a";t.fillStyle=Q,t.fillRect(0,0,L,H);const v=r.audioEngine.getRingBuffer(),T=v.getCurrentTime(),j=i(),b=T-j,w=v.sampleRate,q=Math.floor(H*.55),I=Math.floor(H*.35),B=H-q-I,A=q,te=q+I;if(r.melClient&&a&&n){if(C-o>c){o=C;const O=Math.round(b*w),ue=Math.round(T*w);r.melClient.getFeatures(O,ue,!1).then(V=>{V&&a&&n&&(R={features:V.features,melBins:V.melBins,timeSteps:V.T,startTime:b,endTime:T},X(a,V.features,V.melBins,V.T,L,q))}).catch(()=>{})}if(R&&R.timeSteps>0){const O=R.endTime-R.startTime,ue=b-R.startTime,V=Math.floor(ue/O*L);t.drawImage(n,V,0,L-V,q,0,0,L-V,q)}}try{const O=Math.floor(b*w),ue=Math.floor(T*w),V=ue-O,Se=v.getBaseFrameOffset();if(O>=Se&&V>0)if(v.readInto){(!z||z.length<V)&&(z=new Float32Array(V));const ke=v.readInto(O,ue,z);ce(t,z.subarray(0,ke),L,I,A)}else{const ke=v.read(O,ue);ce(t,ke,L,I,A)}}catch{}ge(t,L,B,te,b,j,P),ye(t,L,H,b,j,P),s=requestAnimationFrame(G)},X=(C,P,L,H,Q,v)=>{if(H===0)return;(!x||S!==Q||y!==v)&&(x=C.createImageData(Q,v),S=Q,y=v);const T=x,j=T.data,b=H/Q,w=L/v;for(let q=0;q<Q;q++){const I=Math.floor(q*b);if(I>=H)break;for(let B=0;B<v;B++){const A=Math.floor((v-1-B)*w);if(A>=L)continue;const te=P[A*H+I],V=(Hr(te)*255|0)*3,Se=(B*Q+q)*4;j[Se]=$t[V],j[Se+1]=$t[V+1],j[Se+2]=$t[V+2],j[Se+3]=255}}C.putImageData(T,0,0)},J=1,ce=(C,P,L,H,Q)=>{if(P.length===0)return;const v=Math.ceil(P.length/L),T=H/2*J,j=Q+H/2;C.strokeStyle="#4ade80",C.lineWidth=1,C.beginPath();for(let b=0;b<L;b++){const w=b*v,q=Math.min((b+1)*v,P.length);let I=1,B=-1,A=!1;for(let te=w;te<q;te+=Math.max(1,Math.floor((q-w)/10))){const O=P[te];O<I&&(I=O),O>B&&(B=O),A=!0}if(A){const te=j-I*T,O=j-B*T;C.moveTo(b,Math.max(Q,Math.min(Q+H,te))),C.lineTo(b,Math.max(Q,Math.min(Q+H,O)))}}C.stroke()},ge=(C,P,L,H,Q,v,T)=>{const b=l.vadState().isSpeech;C.fillStyle=b?"rgba(249, 115, 22, 0.4)":"rgba(100, 116, 139, 0.2)",C.fillRect(0,H,P,L);const w=l.audioLevel(),q=l.energyThreshold();if(w>0){const I=Math.min(P,P*(w/.3));C.fillStyle=w>q?"rgba(249, 115, 22, 0.8)":"rgba(74, 222, 128, 0.6)",C.fillRect(P-I,H,I,L)}C.strokeStyle="rgba(148, 163, 184, 0.3)",C.lineWidth=1*T,C.beginPath(),C.moveTo(0,H),C.lineTo(P,H),C.stroke(),C.fillStyle=b?"#fb923c":"#64748b",C.font=`${8*T}px monospace`,C.fillText(b?"SPEECH":"SILENCE",4*T,H+L-2*T)},ye=(C,P,L,H,Q,v)=>{const T=P-1.5/Q*P;C.strokeStyle="rgba(255, 255, 0, 0.5)",C.lineWidth=1*v,C.beginPath(),C.moveTo(T,0),C.lineTo(T,L),C.stroke(),C.fillStyle="#94a3b8",C.font=`${10*v}px monospace`;for(let j=0;j<=8;j+=2){const b=j,w=P-b/Q*P;C.fillText(`-${b}s`,w+3*v,L-6*v)}};return(()=>{var C=jr(),P=C.firstChild,L=P.nextSibling,H=L.firstChild,Q=H.nextSibling;Q.nextSibling;var v=e;return typeof v=="function"?rt(v,P):e=P,f(L,i,Q),ee(T=>Ce(C,"height",`${r.height||200}px`)),C})()};Ge(["click"]);var Gr=$('<span class="text-2xl md:text-3xl leading-[1.6] text-[var(--color-earthy-coral)] font-medium italic ml-1 transition-all duration-300"><span class="inline-block w-[3px] h-8 bg-[var(--color-earthy-coral)] align-middle ml-1 opacity-60 animate-pulse">'),Yr=$('<div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-[var(--color-earthy-coral)] animate-pulse"></div><span class="text-[10px] font-semibold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Listening...</span><div class="flex gap-1"><div class="w-1.5 h-1.5 bg-[var(--color-earthy-muted-green)] rounded-full animate-bounce opacity-60"></div><div class="w-1.5 h-1.5 bg-[var(--color-earthy-muted-green)] rounded-full animate-bounce opacity-80 [animation-delay:0.2s]"></div><div class="w-1.5 h-1.5 bg-[var(--color-earthy-muted-green)] rounded-full animate-bounce [animation-delay:0.4s]">'),Zr=$('<div class="story-font space-y-12 py-4"><div class=group><div class="pl-4 border-l-2 border-[var(--color-earthy-coral)]/30 group-hover:border-[var(--color-earthy-coral)]/50 transition-colors duration-300"><p class="text-2xl md:text-3xl leading-[1.6] text-[var(--color-earthy-dark-brown)] font-normal inline">'),Kr=$('<div class="mt-4 flex items-center gap-4 text-[10px] font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-widest bg-[var(--color-earthy-bg)]/80 backdrop-blur-sm self-start px-4 py-2 rounded-full border border-[var(--color-earthy-sage)]/50"><div class="flex items-center gap-1.5"><span></span><span>LCS: </span></div><div class="w-px h-3 bg-[var(--color-earthy-sage)]"></div><span class=opacity-60>PTFA Merged'),Xr=$('<div><div class="flex-1 overflow-y-auto scroll-smooth">'),Qr=$('<div class="flex flex-col items-center justify-center h-full opacity-50 story-font"><span class="material-symbols-outlined text-5xl mb-4 text-[var(--color-earthy-soft-brown)]">graphic_eq</span><p class="text-2xl md:text-3xl leading-[1.6] text-[var(--color-earthy-muted-green)] italic">');const Jr=r=>{let e,t=!1;const s=()=>{t||(t=!0,requestAnimationFrame(()=>{t=!1,e&&(e.scrollTop=e.scrollHeight)}))},i=De(()=>(r.confirmedText?.length??0)>0||(r.pendingText?.length??0)>0);let n;return bt(()=>{e&&(n=new MutationObserver(s),n.observe(e,{childList:!0,subtree:!0}))}),Oe(()=>{n?.disconnect()}),(()=>{var a=Xr(),o=a.firstChild,c=e;return typeof c=="function"?rt(c,o):e=o,f(o,F(Z,{get when(){return i()},get fallback(){return(()=>{var h=Qr(),u=h.firstChild,d=u.nextSibling;return f(d,()=>r.placeholder??"Ready to transcribe..."),h})()},get children(){var h=Zr(),u=h.firstChild,d=u.firstChild,m=d.firstChild;return f(m,()=>r.confirmedText),f(d,F(Z,{get when(){return r.pendingText},get children(){var p=Gr(),k=p.firstChild;return f(p,()=>r.pendingText,k),p}}),null),f(h,F(Z,{get when(){return Te(()=>!!(r.isRecording&&!r.pendingText))()&&!r.confirmedText},get children(){return Yr()}}),null),h}})),f(a,F(Z,{get when(){return Te(()=>!!(r.showConfidence&&r.isRecording))()&&r.lcsLength!==void 0},get children(){var h=Kr(),u=h.firstChild,d=u.firstChild,m=d.nextSibling;return m.firstChild,f(m,()=>r.lcsLength,null),ee(()=>oe(d,`w-2 h-2 rounded-full ${r.anchorValid?"bg-[var(--color-earthy-muted-green)]":"bg-[var(--color-earthy-coral)]"}`)),h}}),null),ee(()=>oe(a,`flex flex-col h-full bg-transparent ${r.class??""}`)),a})()};var es=$('<div class="h-12 w-full overflow-hidden rounded-md bg-[var(--color-earthy-bg)]"><canvas class="w-full h-full block">');const ts=r=>{let e,t=null,s,i=null;const n=()=>{if(!e?.parentElement)return;const o=e.parentElement.getBoundingClientRect(),c=window.devicePixelRatio||1,h=Math.floor(o.width*c),u=Math.floor(o.height*c);(e.width!==h||e.height!==u)&&(e.width=h,e.height=u)},a=()=>{if(s=requestAnimationFrame(a),!t||!e)return;const o=e.width,c=e.height;if(o===0||c===0)return;const h=r.barLevels,u=h&&h.length>0?h.length:0,d=getComputedStyle(e).getPropertyValue("--color-earthy-bg").trim()||"#faf8f5",m=getComputedStyle(e).getPropertyValue("--color-primary").trim()||"#14b8a6";if(t.fillStyle=d,t.fillRect(0,0,o,c),r.isRecording&&h&&u>0){const p=c/2,k=c/2*.9;t.strokeStyle=m,t.lineWidth=2,t.beginPath(),t.moveTo(0,p-Math.max(-1,Math.min(1,h[0]))*k);for(let _=1;_<u;_++){const E=_/(u-1)*o,x=p-Math.max(-1,Math.min(1,h[_]))*k;t.lineTo(E,x)}t.stroke()}};return bt(()=>{e&&(n(),t=e.getContext("2d",{alpha:!1}),(i=typeof ResizeObserver<"u"?new ResizeObserver(n):null)&&i.observe(e.parentElement??e)),s=requestAnimationFrame(a)}),Oe(()=>{cancelAnimationFrame(s),i?.disconnect()}),(()=>{var o=es(),c=o.firstChild,h=e;return typeof h=="function"?rt(h,c):e=c,o})()},rs=r=>F(ts,Ir(r,{get barCount(){return r.barLevels?.length}}));var ss=$('<button type=button class="absolute top-8 right-8 neu-square-btn text-[var(--color-earthy-soft-brown)] hover:text-[var(--color-earthy-coral)] transition-all z-10"aria-label=Close><span class="material-symbols-outlined text-xl">close'),is=$("<span>"),ns=$('<div class=space-y-4><div class="grid gap-4"><button class="flex items-center text-left p-6 rounded-3xl nm-flat opacity-70 hover:opacity-100 transition-all hover:shadow-neu-btn-hover"><div class="w-10 h-10 rounded-2xl nm-inset flex items-center justify-center mr-5"><span class="material-symbols-outlined text-[var(--color-earthy-soft-brown)] text-xl">file_open</span></div><div><div class="font-bold text-lg leading-tight">Local Model</div><div class="text-[10px] font-black opacity-40 uppercase tracking-widest mt-1">Load from disk</div></div></button></div><button class="w-full mt-6 py-5 bg-[var(--color-earthy-muted-green)] text-white font-extrabold rounded-3xl shadow-xl active:scale-[0.98] transition-all uppercase tracking-widest text-xs">Initialize AI Engine'),os=$('<div class=mt-4><div class="h-4 nm-inset rounded-full overflow-hidden p-1"><div class="h-full bg-[var(--color-earthy-muted-green)] rounded-full transition-all duration-300 ease-out shadow-[0_0_12px_var(--color-earthy-muted-green)]"></div></div><div class="flex justify-between items-center mt-6 px-1"><div class="flex flex-col"><span class="text-[10px] font-black text-[var(--color-earthy-soft-brown)] uppercase tracking-widest leading-none mb-1">Downloaded</span><span class="text-[var(--color-earthy-muted-green)] font-black text-2xl">%</span></div><div class="flex flex-col text-right"><span class="text-[10px] font-black text-[var(--color-earthy-soft-brown)] uppercase tracking-widest leading-none mb-1">Active File</span><span class="text-[var(--color-earthy-soft-brown)] font-bold text-[11px] truncate max-w-[200px]">'),as=$('<div><button class="w-full py-5 nm-flat text-[var(--color-earthy-coral)] font-black rounded-3xl shadow-none hover:opacity-90 transition-all">Retry Connection'),ls=$('<div class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--color-earthy-dark-brown)]/30 backdrop-blur-sm"role=dialog aria-modal=true aria-labelledby=model-overlay-title><input type=file multiple class=hidden><div class="w-full max-w-lg mx-4"><div class="relative nm-flat rounded-[40px] overflow-hidden transition-all duration-300 animate-in fade-in slide-in-from-bottom-4"><div class="p-10 pb-6 text-center"><div class="w-20 h-20 mx-auto mb-8 rounded-[32px] nm-inset flex items-center justify-center"></div><h2 id=model-overlay-title class="text-3xl font-extrabold text-[var(--color-earthy-dark-brown)] tracking-tight"></h2><p class="text-sm text-[var(--color-earthy-soft-brown)] font-medium mt-3 px-10"></p></div><div class="px-10 pb-10"></div><div class="px-10 py-6 border-t border-[var(--color-earthy-sage)]/30 flex items-center justify-between opacity-80"><div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-[var(--color-earthy-soft-brown)]">offline_bolt</span><span class="text-[10px] font-black text-[var(--color-earthy-soft-brown)] uppercase tracking-widest"></span></div><span class="text-[10px] text-[var(--color-earthy-sage)] font-black tracking-widest">PRIVACY SECURED'),cs=$('<span class="material-symbols-outlined text-[var(--color-earthy-coral)] text-4xl">warning'),ds=$('<div class="w-2.5 h-2.5 bg-[var(--color-earthy-muted-green)] rounded-full shadow-[0_0_8px_var(--color-earthy-muted-green)]">'),hs=$('<button><div></div><div><div class="font-bold text-lg leading-tight"></div><div class="text-[10px] font-black opacity-40 uppercase tracking-widest mt-1">');const Pt=[{id:"parakeet-tdt-0.6b-v2",name:"Parakeet v2",desc:"English optimized"},{id:"parakeet-tdt-0.6b-v3",name:"Parakeet v3",desc:"Multilingual Streaming"}];function sr(r){return(Pt.find(e=>e.id===r)?.name??r)||"Unknown model"}const us=r=>{const e=()=>`${Math.max(0,Math.min(100,r.progress))}%`;let t;const s=n=>{const a=n.target.files;a&&a.length>0&&r.onLocalLoad(a)},i=()=>r.onClose?.();return Qe(()=>{if(!r.isVisible||!r.onClose)return;const n=a=>{a.key==="Escape"&&(a.preventDefault(),r.onClose?.())};return document.addEventListener("keydown",n),()=>document.removeEventListener("keydown",n)}),F(Z,{get when(){return r.isVisible},get children(){var n=ls(),a=n.firstChild,o=a.nextSibling,c=o.firstChild,h=c.firstChild,u=h.firstChild,d=u.nextSibling,m=d.nextSibling,p=h.nextSibling,k=p.nextSibling,_=k.firstChild,E=_.firstChild,x=E.nextSibling;n.$$click=y=>y.target===y.currentTarget&&i(),a.addEventListener("change",s);var S=t;return typeof S=="function"?rt(S,a):t=a,f(c,F(Z,{get when(){return r.onClose},get children(){var y=ss();return y.$$click=i,y}}),h),f(u,F(Z,{get when(){return r.state!=="error"},get fallback(){return cs()},get children(){var y=is();return f(y,()=>r.state==="loading"?"downloading":"neurology"),ee(()=>oe(y,`material-symbols-outlined text-[var(--color-earthy-muted-green)] text-4xl ${r.state==="loading"?"animate-pulse":""}`)),y}})),f(d,(()=>{var y=Te(()=>r.state==="unloaded");return()=>y()?"Engine Selection":r.state==="error"?"Loading Failed":"Model Installation"})()),f(m,(()=>{var y=Te(()=>r.state==="unloaded");return()=>y()?"Select the AI engine for this transcription session.":r.message})()),f(p,F(Z,{get when(){return r.state==="unloaded"},get children(){var y=ns(),z=y.firstChild,R=z.firstChild,G=z.nextSibling;return f(z,F(je,{each:Pt,children:X=>(()=>{var J=hs(),ce=J.firstChild,ge=ce.nextSibling,ye=ge.firstChild,C=ye.nextSibling;return J.$$click=()=>r.onModelSelect(X.id),f(ce,F(Z,{get when(){return r.selectedModelId===X.id},get children(){return ds()}})),f(ye,()=>X.name),f(C,()=>X.desc),ee(P=>{var L=`flex items-center text-left p-6 rounded-3xl transition-all ${r.selectedModelId===X.id?"nm-inset text-[var(--color-earthy-muted-green)] ring-2 ring-[var(--color-earthy-muted-green)]/20":"nm-flat text-[var(--color-earthy-dark-brown)] hover:shadow-neu-btn-hover"}`,H=`w-6 h-6 rounded-full nm-inset mr-5 flex flex-none items-center justify-center ${r.selectedModelId===X.id?"text-[var(--color-earthy-muted-green)]":"text-[var(--color-earthy-sage)]"}`;return L!==P.e&&oe(J,P.e=L),H!==P.t&&oe(ce,P.t=H),P},{e:void 0,t:void 0}),J})()}),R),R.$$click=()=>t?.click(),G.$$click=()=>r.onStart(),y}}),null),f(p,F(Z,{get when(){return r.state==="loading"},get children(){var y=os(),z=y.firstChild,R=z.firstChild,G=z.nextSibling,X=G.firstChild,J=X.firstChild,ce=J.nextSibling,ge=ce.firstChild,ye=X.nextSibling,C=ye.firstChild,P=C.nextSibling;return f(ce,()=>r.progress,ge),f(P,()=>r.file||"Preparing assets..."),ee(L=>Ce(R,"width",e())),y}}),null),f(p,F(Z,{get when(){return r.state==="error"},get children(){var y=as(),z=y.firstChild;return z.$$click=()=>r.onStart(),y}}),null),f(x,()=>r.backend==="webgpu"?"GPU Accelerated":"WASM Native"),n}})};Ge(["click"]);var fs=$('<div class="space-y-1 pt-1 border-t border-[var(--color-earthy-sage)]"><span class="font-bold text-[8px] text-[var(--color-earthy-soft-brown)] uppercase tracking-wider">Merger</span><div class="grid grid-cols-3 gap-1"><div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded px-1 py-0.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase">Sent</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]"></div></div><div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded px-1 py-0.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase">Cursor</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]">s</div></div><div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded px-1 py-0.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase">Uttr</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]">'),gs=$('<div><div class="flex justify-between font-bold text-[var(--color-earthy-soft-brown)] uppercase text-[9px]"><span>VAD Prob</span><span>%</span></div><div class="h-2 w-full bg-[var(--color-earthy-sage)] rounded overflow-hidden relative"><div class="absolute top-0 bottom-0 w-px bg-[var(--color-earthy-coral)] z-10"title="VAD threshold"></div><div>'),ps=$('<div><span class="font-bold text-[9px] text-[var(--color-earthy-soft-brown)] uppercase">SNR</span><span> dB'),ms=$('<div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded p-1.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase mb-px">Overlap</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]">s'),vs=$('<div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded p-1.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase mb-px">Chunks</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]">'),ys=$('<div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded p-1.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase mb-px">State</div><div>'),bs=$('<div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded p-1.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase mb-px">Windows</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]">'),Ss=$('<div class="flex items-center gap-3"><div class="flex items-center gap-1.5 px-2 py-0.5 bg-[var(--color-earthy-bg)] rounded border border-[var(--color-earthy-sage)]"><div></div><span class="font-bold uppercase text-[var(--color-earthy-soft-brown)] tracking-wide">Lock</span></div><div class="flex items-center gap-1.5 px-2 py-0.5 bg-[var(--color-earthy-bg)] rounded border border-[var(--color-earthy-sage)]"><span class="material-symbols-outlined text-[14px] text-[var(--color-earthy-soft-brown)]">join_inner</span><span class="font-bold uppercase text-[var(--color-earthy-dark-brown)]">Match: <span class=text-[var(--color-earthy-muted-green)]>'),xs=$('<div class="flex items-center gap-3"><div class="flex items-center gap-1.5 px-2 py-0.5 bg-[var(--color-earthy-bg)] rounded border border-[var(--color-earthy-sage)]"><div></div><div class="w-24 overflow-hidden text-ellipsis whitespace-nowrap"><span class="font-bold uppercase text-[var(--color-earthy-soft-brown)] tracking-wide"></span></div></div><div><span class="font-bold uppercase text-[var(--color-earthy-soft-brown)] text-[9px]">VAD</span><span>%'),ws=$('<span class="text-[11px] text-[var(--color-earthy-dark-brown)] leading-relaxed">'),Cs=$('<span class="text-[11px] text-[var(--color-earthy-coral)] italic leading-relaxed">'),$s=$('<span class="inline-block w-0.5 h-3 bg-[var(--color-earthy-coral)] animate-pulse ml-0.5 align-middle">'),_s=$('<div class="text-[9px] text-[var(--color-earthy-soft-brown)] flex items-center gap-3 pt-1"><span> sentences finalized</span><span class=text-[var(--color-earthy-sage)]>|</span><span>Cursor at <!>s</span><span class=text-[var(--color-earthy-sage)]>|</span><span> windows processed'),Ts=$('<div class=space-y-3><div class=space-y-1.5><h4 class="font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-widest flex items-center gap-2 text-[9px]"><span class="w-1.5 h-1.5 bg-[var(--color-earthy-muted-green)] rounded-full"></span>Finalized Sentences</h4><div class="p-2 border border-[var(--color-earthy-sage)] bg-[var(--color-earthy-muted-green)]/10 rounded h-32 overflow-y-auto resize-y"></div></div><div class=space-y-1.5><h4 class="font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-widest flex items-center gap-2 text-[9px]"><span class="w-1.5 h-1.5 bg-[var(--color-earthy-coral)] rounded-full animate-pulse"></span>Active Sentence</h4><div class="p-2 border border-[var(--color-earthy-coral)]/30 bg-[var(--color-earthy-coral)]/10 rounded min-h-[36px]">'),ks=$('<span class="px-1.5 py-0.5 text-[var(--color-earthy-coral)] font-medium italic border border-dashed border-[var(--color-earthy-coral)]/30 rounded bg-[var(--color-earthy-coral)]/10">...'),Es=$('<span class="text-[var(--color-earthy-soft-brown)] italic text-[10px] w-full text-center py-2 op-50">Waiting for speech input...'),Ms=$('<div class=space-y-2><h4 class="font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-widest flex items-center gap-2 text-[9px]"><span class="w-1 h-1 bg-[var(--color-earthy-sage)] rounded-full"></span>Transition Cache</h4><div class="p-2 border border-[var(--color-earthy-sage)] bg-[var(--color-earthy-sage)]/10 rounded min-h-[48px] flex flex-wrap gap-1.5 content-start">'),Rs=$('<span class="text-[var(--color-earthy-soft-brown)] text-[10px] italic px-1 opacity-50">No stable anchors locked yet.'),Fs=$('<div class=space-y-2><h4 class="font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-widest flex items-center gap-2 text-[9px]"><span class="w-1 h-1 bg-[var(--color-earthy-muted-green)] rounded-full"></span>Stable Anchors</h4><div class="flex flex-wrap gap-1">'),As=$('<div class="text-[var(--color-earthy-soft-brown)] italic text-center py-4">Legacy per-utterance mode. Segments are transcribed individually.'),Ds=$('<div class="bg-[var(--color-earthy-bg)] border-t border-[var(--color-earthy-sage)] text-[10px] font-mono text-[var(--color-earthy-dark-brown)] flex overflow-hidden shrink-0 transition-colors duration-300 selection:bg-[var(--color-earthy-coral)]/20 selection:text-[var(--color-earthy-coral)] z-20 relative"><div class="absolute top-0 left-0 w-full h-1 cursor-ns-resize z-50 hover:bg-[var(--color-earthy-muted-green)]/50 transition-colors bg-transparent"></div><div class="w-60 flex flex-col p-3 gap-2.5 border-r border-[var(--color-earthy-sage)] bg-[var(--color-earthy-sage)]/10 overflow-y-auto"><div class="flex items-center justify-between pb-2 border-b border-[var(--color-earthy-sage)]"><span class="font-bold tracking-wider uppercase text-[var(--color-earthy-soft-brown)]">System & Signal</span><div class="flex items-center gap-2"><span class="font-bold text-[var(--color-earthy-soft-brown)] uppercase text-[9px]"></span><div></div><span>VAD</span></div></div><div class=space-y-1.5><span class="font-bold text-[9px] text-[var(--color-earthy-soft-brown)] uppercase tracking-wider">Mode</span><div class="flex gap-1"></div></div><div class="grid grid-cols-2 gap-1.5"><div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded p-1.5 flex flex-col items-center justify-center"><span class="font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-tight text-[8px] mb-0.5">RTFx</span><span></span></div><div class="bg-[var(--color-earthy-bg)] border border-[var(--color-earthy-sage)] rounded p-1.5 flex flex-col items-center justify-center"><span class="font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-tight text-[8px] mb-0.5">Latency</span><span class="text-xs font-bold text-[var(--color-earthy-dark-brown)]">ms</span></div></div><div class=space-y-1><div class="flex justify-between font-bold text-[var(--color-earthy-soft-brown)] uppercase px-0.5 text-[9px]"><span>Buffer</span><span>%</span></div><div class="h-1.5 w-full bg-[var(--color-earthy-sage)] rounded-full overflow-hidden"><div class="h-full bg-[var(--color-earthy-muted-green)] transition-all duration-300 ease-out rounded-full"></div></div></div><div class=space-y-1><div class="flex justify-between font-bold text-[var(--color-earthy-soft-brown)] uppercase text-[9px]"><span>RMS Energy</span><span>%</span></div><div class="h-2 w-full bg-[var(--color-earthy-sage)] rounded overflow-hidden relative"><div class="absolute top-0 bottom-0 w-px bg-[var(--color-earthy-coral)] z-10"title="Energy threshold"></div><div></div></div></div><div class="grid grid-cols-2 gap-1.5 pt-1 border-t border-[var(--color-earthy-sage)]"></div></div><div class="flex-1 flex flex-col min-w-0 bg-[var(--color-earthy-bg)]"><div class="px-3 py-2 border-b border-[var(--color-earthy-sage)] bg-[var(--color-earthy-sage)]/10 flex items-center justify-between"><span class="font-bold tracking-wider uppercase text-[var(--color-earthy-soft-brown)]"></span></div><div class="flex-1 overflow-y-auto p-3 space-y-4 custom-scrollbar"><div class="pt-2 border-t border-[var(--color-earthy-sage)]">'),Is=$("<button>"),Ps=$('<span class="text-[var(--color-earthy-soft-brown)] italic text-[10px] opacity-50">No finalized sentences yet...'),Ls=$('<span class="text-[var(--color-earthy-soft-brown)] italic text-[10px] opacity-50">Waiting for speech...'),Bs=$('<div class="px-1.5 py-0.5 rounded text-[10px] font-medium border transition-colors">'),zs=$('<span class="px-1.5 py-0.5 bg-[var(--color-earthy-muted-green)]/20 text-[var(--color-earthy-muted-green)] border border-[var(--color-earthy-sage)] rounded font-medium">');const Vs=[{id:"v4-utterance",label:"Utterance (v4)",short:"v4"},{id:"v3-streaming",label:"Streaming (v3)",short:"v3"},{id:"v2-utterance",label:"Legacy (v2)",short:"v2"}],Ns=r=>{const e=()=>l.recordingState()==="recording",t=()=>l.transcriptionMode()==="v4-utterance",s=()=>l.transcriptionMode()==="v3-streaming",[i,n]=M(260),[a,o]=M(!1);let c=0,h=0,u;Qe(()=>{l.matureText(),u&&(u.scrollTop=u.scrollHeight)});const d=_=>{o(!0),c=_.clientY,h=i(),window.addEventListener("mousemove",m),window.addEventListener("mouseup",p)},m=_=>{if(!a())return;const E=c-_.clientY,x=Math.min(Math.max(h+E,150),600);n(x)},p=()=>{o(!1),window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",p)};Oe(()=>{window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",p)});const k=De(()=>{const _=l.rtfxAverage();return _===0?"text-[var(--color-earthy-soft-brown)]":_>=2?"text-[var(--color-earthy-muted-green)] font-bold":(_>=1,"text-[var(--color-earthy-coral)] font-bold")});return(()=>{var _=Ds(),E=_.firstChild,x=E.nextSibling,S=x.firstChild,y=S.firstChild,z=y.nextSibling,R=z.firstChild,G=R.nextSibling,X=G.nextSibling,J=S.nextSibling,ce=J.firstChild,ge=ce.nextSibling,ye=J.nextSibling,C=ye.firstChild,P=C.firstChild,L=P.nextSibling,H=C.nextSibling,Q=H.firstChild,v=Q.nextSibling,T=v.firstChild,j=ye.nextSibling,b=j.firstChild,w=b.firstChild,q=w.nextSibling,I=q.firstChild,B=b.nextSibling,A=B.firstChild,te=j.nextSibling,O=te.firstChild,ue=O.firstChild,V=ue.nextSibling,Se=V.firstChild,ke=O.nextSibling,_e=ke.firstChild,We=_e.nextSibling,ze=te.nextSibling,Re=x.nextSibling,xe=Re.firstChild,Ve=xe.firstChild,Fe=xe.nextSibling,Pe=Fe.firstChild;return E.$$mousedown=d,f(R,()=>l.backend()),f(ge,F(je,{each:Vs,children:g=>(()=>{var N=Is();return N.$$click=()=>{e()||l.setTranscriptionMode(g.id)},f(N,()=>g.short),ee(D=>{var W=`flex-1 px-1 py-1 rounded text-[9px] font-bold uppercase tracking-wide border transition-all ${l.transcriptionMode()===g.id?"bg-[var(--color-earthy-muted-green)] text-white border-[var(--color-earthy-muted-green)] shadow-sm":"bg-[var(--color-earthy-bg)] text-[var(--color-earthy-soft-brown)] border-[var(--color-earthy-sage)] hover:border-[var(--color-earthy-soft-brown)] hover:bg-[var(--color-earthy-sage)]/20"} ${e()?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,U=e(),Y=e()?"Stop recording to change mode":g.label;return W!==D.e&&oe(N,D.e=W),U!==D.t&&(N.disabled=D.t=U),Y!==D.a&&qe(N,"title",D.a=Y),D},{e:void 0,t:void 0,a:void 0}),N})()})),f(L,(()=>{var g=Te(()=>l.rtfxAverage()>0);return()=>g()?Math.round(l.rtfxAverage()):"â€“"})()),f(v,()=>Math.round(l.inferenceLatencyAverage()),T),f(q,()=>(l.bufferMetrics().fillRatio*100).toFixed(0),I),f(x,F(Z,{get when(){return t()},get children(){var g=fs(),N=g.firstChild,D=N.nextSibling,W=D.firstChild,U=W.firstChild,Y=U.nextSibling,ie=W.nextSibling,ae=ie.firstChild,K=ae.nextSibling,se=K.firstChild,we=ie.nextSibling,Ee=we.firstChild,$e=Ee.nextSibling;return f(Y,()=>l.v4MergerStats().sentencesFinalized),f(K,()=>l.matureCursorTime().toFixed(1),se),f($e,()=>l.v4MergerStats().utterancesProcessed),g}}),te),f(V,()=>(l.audioLevel()*100).toFixed(1),Se),f(x,F(Z,{get when(){return t()},get children(){return[(()=>{var g=gs(),N=g.firstChild,D=N.firstChild,W=D.nextSibling,U=W.firstChild,Y=N.nextSibling,ie=Y.firstChild,ae=ie.nextSibling;return f(W,()=>(l.vadState().sileroProbability*100).toFixed(0),U),ee(K=>{var se=`space-y-1 transition-opacity duration-300 ${l.vadState().sileroProbability>0?"opacity-100":"opacity-40"}`,we=l.vadState().sileroProbability>l.sileroThreshold()?"text-[var(--color-earthy-coral)] font-bold":"text-[var(--color-earthy-soft-brown)]",Ee=`${l.sileroThreshold()*100}%`,$e=`h-full transition-all duration-75 ${l.vadState().sileroProbability>l.sileroThreshold()?"bg-[var(--color-earthy-coral)]":"bg-[var(--color-earthy-soft-brown)]"}`,Ue=`${Math.min(100,l.vadState().sileroProbability*100)}%`;return se!==K.e&&oe(g,K.e=se),we!==K.t&&oe(W,K.t=we),Ee!==K.a&&Ce(ie,"left",K.a=Ee),$e!==K.o&&oe(ae,K.o=$e),Ue!==K.i&&Ce(ae,"width",K.i=Ue),K},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),g})(),(()=>{var g=ps(),N=g.firstChild,D=N.nextSibling,W=D.firstChild;return f(D,()=>l.vadState().snr.toFixed(1),W),ee(U=>{var Y=`flex justify-between items-center bg-[var(--color-earthy-bg)] p-1.5 rounded border border-[var(--color-earthy-sage)] transition-opacity duration-300 ${l.vadState().snr!==0?"opacity-100":"opacity-40"}`,ie=`font-bold text-[10px] ${l.vadState().snr>3?"text-[var(--color-earthy-muted-green)]":"text-[var(--color-earthy-soft-brown)]"}`;return Y!==U.e&&oe(g,U.e=Y),ie!==U.t&&oe(D,U.t=ie),U},{e:void 0,t:void 0}),g})()]}}),ze),f(ze,F(Z,{get when(){return s()},get children(){return[(()=>{var g=ms(),N=g.firstChild,D=N.nextSibling,W=D.firstChild;return f(D,()=>l.streamingOverlap().toFixed(1),W),g})(),(()=>{var g=vs(),N=g.firstChild,D=N.nextSibling;return f(D,()=>l.mergeInfo().chunkCount),g})()]}}),null),f(ze,F(Z,{get when(){return t()},get children(){return[(()=>{var g=ys(),N=g.firstChild,D=N.nextSibling;return f(D,()=>l.vadState().hybridState),ee(()=>oe(D,`text-[10px] font-bold whitespace-nowrap w-24 overflow-hidden text-ellipsis mx-auto ${l.vadState().isSpeech?"text-[var(--color-earthy-coral)]":"text-[var(--color-earthy-soft-brown)]"}`)),g})(),(()=>{var g=bs(),N=g.firstChild,D=N.nextSibling;return f(D,()=>l.v4MergerStats().utterancesProcessed),g})()]}}),null),f(Ve,(()=>{var g=Te(()=>!!t());return()=>g()?"Transcript State":s()?"Stream Sync":"Segments"})()),f(xe,F(Z,{get when(){return s()},get children(){var g=Ss(),N=g.firstChild,D=N.firstChild,W=N.nextSibling,U=W.firstChild,Y=U.nextSibling,ie=Y.firstChild,ae=ie.nextSibling;return f(ae,()=>l.mergeInfo().lcsLength),ee(()=>oe(D,`w-1.5 h-1.5 rounded-full transition-colors duration-300 ${l.mergeInfo().anchorValid?"bg-[var(--color-earthy-muted-green)]":"bg-[var(--color-earthy-coral)]"}`)),g}}),null),f(xe,F(Z,{get when(){return t()},get children(){var g=xs(),N=g.firstChild,D=N.firstChild,W=D.nextSibling,U=W.firstChild,Y=N.nextSibling,ie=Y.firstChild,ae=ie.nextSibling,K=ae.firstChild;return f(U,()=>l.vadState().hybridState),f(ae,()=>(l.vadState().sileroProbability*100).toFixed(0),K),ee(se=>{var we=`w-1.5 h-1.5 rounded-full transition-colors duration-300 ${l.vadState().isSpeech?"bg-[var(--color-earthy-coral)] animate-pulse":"bg-[var(--color-earthy-sage)]"}`,Ee=`flex items-center gap-1.5 px-2 py-0.5 bg-[var(--color-earthy-bg)] rounded border border-[var(--color-earthy-sage)] transition-opacity duration-300 ${l.vadState().sileroProbability>0?"opacity-100":"opacity-0"}`,$e=`font-bold ${l.vadState().sileroProbability>.5?"text-[var(--color-earthy-coral)]":"text-[var(--color-earthy-soft-brown)]"}`;return we!==se.e&&oe(D,se.e=we),Ee!==se.t&&oe(Y,se.t=Ee),$e!==se.a&&oe(ae,se.a=$e),se},{e:void 0,t:void 0,a:void 0}),g}}),null),f(Fe,F(Z,{get when(){return t()},get children(){var g=Ts(),N=g.firstChild,D=N.firstChild,W=D.nextSibling,U=N.nextSibling,Y=U.firstChild,ie=Y.nextSibling,ae=u;return typeof ae=="function"?rt(ae,W):u=W,f(W,F(Z,{get when(){return l.matureText()},get fallback(){return Ps()},get children(){var K=ws();return f(K,()=>l.matureText()),K}})),f(ie,F(Z,{get when(){return l.immatureText()},get fallback(){return Ls()},get children(){return[(()=>{var K=Cs();return f(K,()=>l.immatureText()),K})(),$s()]}})),f(g,F(Z,{get when(){return l.v4MergerStats().sentencesFinalized>0},get children(){var K=_s(),se=K.firstChild,we=se.firstChild,Ee=se.nextSibling,$e=Ee.nextSibling,Ue=$e.firstChild,st=Ue.nextSibling;st.nextSibling;var St=$e.nextSibling,it=St.nextSibling,xt=it.firstChild;return f(se,()=>l.v4MergerStats().sentencesFinalized,we),f($e,()=>l.matureCursorTime().toFixed(2),st),f(it,()=>l.v4MergerStats().utterancesProcessed,xt),K}}),null),g}}),Pe),f(Fe,F(Z,{get when(){return s()},get children(){return[(()=>{var g=Ms(),N=g.firstChild,D=N.nextSibling;return f(D,F(je,{get each(){return l.debugTokens().slice(-24)},children:W=>(()=>{var U=Bs();return f(U,()=>W.text),ee(Y=>{var ie=W.confidence>.8?"#F9F7F2":"rgba(249,247,242,0.6)",ae=`rgba(107, 112, 92, ${Math.max(.2,W.confidence*.4)})`,K=W.confidence>.8?"#3D405B":"#A5A58D",se=Math.max(.5,W.confidence),we=`Confidence: ${(W.confidence*100).toFixed(0)}%`;return ie!==Y.e&&Ce(U,"background-color",Y.e=ie),ae!==Y.t&&Ce(U,"border-color",Y.t=ae),K!==Y.a&&Ce(U,"color",Y.a=K),se!==Y.o&&Ce(U,"opacity",Y.o=se),we!==Y.i&&qe(U,"title",Y.i=we),Y},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),U})()}),null),f(D,F(Z,{get when(){return l.pendingText()},get children(){var W=ks(),U=W.firstChild;return f(W,()=>l.pendingText(),U),W}}),null),f(D,F(Z,{get when(){return Te(()=>!l.debugTokens().length)()&&!l.pendingText()},get children(){return Es()}}),null),g})(),(()=>{var g=Fs(),N=g.firstChild,D=N.nextSibling;return f(D,F(je,{get each(){return l.mergeInfo().anchorTokens||[]},children:W=>(()=>{var U=zs();return f(U,W),U})()}),null),f(D,F(Z,{get when(){return!l.mergeInfo().anchorTokens?.length},get children(){return Rs()}}),null),g})()]}}),Pe),f(Fe,F(Z,{get when(){return Te(()=>!s())()&&!t()},get children(){return As()}}),Pe),f(Pe,F(qr,{get audioEngine(){return r.audioEngine},get melClient(){return r.melClient},height:120,windowDuration:8})),ee(g=>{var N=`${i()}px`,D=`w-2 h-2 rounded-full border border-[var(--color-earthy-bg)] shadow-sm transition-all duration-300 ${e()?"bg-[var(--color-earthy-coral)] animate-pulse":"bg-[var(--color-earthy-sage)]"}`,W=`font-bold text-white bg-[var(--color-earthy-coral)] px-1.5 py-px rounded text-[9px] transition-opacity duration-100 ${l.isSpeechDetected()?"opacity-100 animate-pulse":"opacity-0"}`,U=`text-xs ${k()}`,Y=`${(l.bufferMetrics().fillRatio*100).toFixed(0)}%`,ie=l.audioLevel()>l.energyThreshold()?"text-[var(--color-earthy-muted-green)]":"text-[var(--color-earthy-soft-brown)]",ae=`${l.energyThreshold()*100}%`,K=`h-full transition-all duration-75 ${l.isSpeechDetected()?"bg-[var(--color-earthy-coral)]":"bg-[var(--color-earthy-muted-green)]"}`,se=`${Math.min(100,l.audioLevel()*100)}%`;return N!==g.e&&Ce(_,"height",g.e=N),D!==g.t&&oe(G,g.t=D),W!==g.a&&oe(X,g.a=W),U!==g.o&&oe(L,g.o=U),Y!==g.i&&Ce(A,"width",g.i=Y),ie!==g.n&&oe(V,g.n=ie),ae!==g.s&&Ce(_e,"left",g.s=ae),K!==g.h&&oe(We,g.h=K),se!==g.r&&Ce(We,"width",g.r=se),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),_})()};Ge(["mousedown","click"]);Ge(["click","input"]);var Os=$('<label class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-[var(--color-earthy-soft-brown)] hover:bg-[var(--color-earthy-sage)]/20 transition-colors cursor-pointer shrink-0"><span class="material-symbols-outlined text-lg">folder_open</span>Load from file<input type=file multiple class=hidden accept=.onnx,.bin>'),Ws=$('<div class=space-y-1><div class="flex justify-between text-xs"><span></span><span class="font-mono text-[var(--color-earthy-muted-green)]">%</span></div><div class="h-1.5 rounded-full overflow-hidden bg-[var(--color-earthy-sage)]/20"><div class="h-full bg-[var(--color-earthy-muted-green)] rounded-full transition-all duration-300">'),Us=$('<section class=space-y-2><h3 class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">ASR model</h3><div class="flex items-center gap-2 flex-wrap"><select class="flex-1 min-w-0 text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]"></select><button type=button class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-[var(--color-earthy-muted-green)] hover:bg-[var(--color-earthy-sage)]/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shrink-0"><span class="material-symbols-outlined text-lg">power_settings_new</span></button></div><p class="text-xs text-[var(--color-earthy-soft-brown)]">'),Hs=$('<section class=space-y-2><h3 class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Audio input</h3><select class="w-full text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]">'),js=$('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">VAD threshold</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">%</span></div><input type=range min=0.1 max=0.9 step=0.05 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),qs=$('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Tick interval</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0"></span></div><input type=range min=320 max=8000 step=80 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30"><div class="flex justify-between text-[9px] text-[var(--color-earthy-soft-brown)]"><span>320ms</span><span>8.0s'),Gs=$('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Silence flush</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">s</span></div><input type=range min=0.3 max=5.0 step=0.1 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),Ys=$('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Window</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">s</span></div><input type=range min=2.0 max=15.0 step=0.5 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),Zs=$('<section class="grid grid-cols-2 gap-x-4 gap-y-3"><div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Energy threshold</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">%</span></div><input type=range min=0.005 max=0.3 step=0.005 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),Ks=$('<div class=pt-2><button type=button class="flex items-center gap-2 px-0 py-2 text-sm font-medium text-[var(--color-earthy-muted-green)] hover:opacity-80 transition-opacity w-full"><span class="material-symbols-outlined text-lg">bug_report</span>Open Debug panel'),Xs=$('<div class="flex flex-col min-h-0"><div class="flex flex-col flex-1 min-h-0 overflow-y-auto p-3 gap-4 custom-scrollbar">'),Nt=$("<option>");const Qs=r=>r>=1e3?`${(r/1e3).toFixed(1)}s`:`${r}ms`,Js=r=>{const e=()=>l.transcriptionMode()==="v4-utterance",t=()=>l.transcriptionMode()==="v3-streaming",s=()=>r.expandUp?.()??!1,i=()=>r.section??"full",n=()=>i()==="full"||i()==="model",a=()=>i()==="full"||i()==="audio",o=()=>i()==="full",c=()=>i()==="full";return(()=>{var h=Xs(),u=h.firstChild;return f(u,F(Z,{get when(){return n()},get children(){var d=Us(),m=d.firstChild,p=m.nextSibling,k=p.firstChild,_=k.nextSibling;_.firstChild;var E=p.nextSibling;return k.$$input=x=>l.setSelectedModelId(x.target.value),f(k,F(je,{each:Pt,children:x=>(()=>{var S=Nt();return f(S,()=>x.name),ee(()=>S.value=x.id),S})()})),tr(_,"click",r.onLoadModel),f(_,(()=>{var x=Te(()=>l.modelState()==="ready");return()=>x()?"Loaded":l.modelState()==="loading"?"...":"Load"})(),null),f(p,F(Z,{get when(){return r.onLocalLoad},get children(){var x=Os(),S=x.firstChild,y=S.nextSibling,z=y.nextSibling;return z.addEventListener("change",R=>{const G=R.currentTarget.files;G&&G.length>0&&r.onLocalLoad?.(G),R.currentTarget.value=""}),x}}),null),f(E,(()=>{var x=Te(()=>l.modelState()==="ready");return()=>x()?sr(l.selectedModelId()):l.modelState()})()),f(d,F(Z,{get when(){return l.modelState()==="loading"},get children(){var x=Ws(),S=x.firstChild,y=S.firstChild,z=y.nextSibling,R=z.firstChild,G=S.nextSibling,X=G.firstChild;return f(y,()=>l.modelMessage()),f(z,()=>Math.round(l.modelProgress()),R),ee(J=>Ce(X,"width",`${Math.max(0,Math.min(100,l.modelProgress()))}%`)),x}}),null),ee(x=>{var S=l.modelState()==="loading",y=l.modelState()==="ready"||l.modelState()==="loading";return S!==x.e&&(k.disabled=x.e=S),y!==x.t&&(_.disabled=x.t=y),x},{e:void 0,t:void 0}),ee(()=>k.value=l.selectedModelId()),d}}),null),f(u,F(Z,{get when(){return a()},get children(){var d=Hs(),m=d.firstChild,p=m.nextSibling;return p.$$input=k=>{const _=k.target.value;l.setSelectedDeviceId(_),r.onDeviceSelect?.(_)},f(p,F(je,{get each(){return l.availableDevices()},children:k=>(()=>{var _=Nt();return f(_,()=>k.label||`Device ${k.deviceId.slice(0,8)}`),ee(()=>_.value=k.deviceId),_})()})),ee(()=>p.value=l.selectedDeviceId()),d}}),null),f(u,F(Z,{get when(){return o()},get children(){var d=Zs(),m=d.firstChild,p=m.firstChild,k=p.firstChild,_=k.nextSibling,E=_.firstChild,x=p.nextSibling;return f(_,()=>(l.energyThreshold()*100).toFixed(1),E),x.$$input=S=>{const y=parseFloat(S.currentTarget.value);l.setEnergyThreshold(y),r.audioEngine?.updateConfig({energyThreshold:y})},f(d,F(Z,{get when(){return e()},get children(){return[(()=>{var S=js(),y=S.firstChild,z=y.firstChild,R=z.nextSibling,G=R.firstChild,X=y.nextSibling;return f(R,()=>(l.sileroThreshold()*100).toFixed(0),G),X.$$input=J=>l.setSileroThreshold(parseFloat(J.currentTarget.value)),ee(()=>X.value=l.sileroThreshold()),S})(),(()=>{var S=qs(),y=S.firstChild,z=y.firstChild,R=z.nextSibling,G=y.nextSibling;return f(R,()=>Qs(l.v4InferenceIntervalMs())),G.$$input=X=>l.setV4InferenceIntervalMs(parseInt(X.currentTarget.value)),ee(()=>G.value=l.v4InferenceIntervalMs()),S})(),(()=>{var S=Gs(),y=S.firstChild,z=y.firstChild,R=z.nextSibling,G=R.firstChild,X=y.nextSibling;return f(R,()=>l.v4SilenceFlushSec().toFixed(1),G),X.$$input=J=>l.setV4SilenceFlushSec(parseFloat(J.currentTarget.value)),ee(()=>X.value=l.v4SilenceFlushSec()),S})()]}}),null),f(d,F(Z,{get when(){return t()},get children(){var S=Ys(),y=S.firstChild,z=y.firstChild,R=z.nextSibling,G=R.firstChild,X=y.nextSibling;return f(R,()=>l.streamingWindow().toFixed(1),G),X.$$input=J=>l.setStreamingWindow(parseFloat(J.currentTarget.value)),ee(()=>X.value=l.streamingWindow()),S}}),null),ee(()=>x.value=l.energyThreshold()),d}}),null),f(u,F(Z,{get when(){return c()},get children(){var d=Ks(),m=d.firstChild;return m.$$click=()=>{r.onOpenDebug(),r.onClose()},d}}),null),ee(()=>u.classList.toggle("flex-col-reverse",!!s())),h})()};Ge(["input","click"]);class Ot{sampleRate;maxFrames;buffer;currentFrame=0;constructor(e,t){this.sampleRate=e,this.maxFrames=Math.floor(e*t),this.buffer=new Float32Array(this.maxFrames)}write(e){let t=e.length,s=e;if(t>this.maxFrames){const a=t-this.maxFrames;s=e.subarray(a),this.currentFrame+=a,t=this.maxFrames}const i=this.currentFrame%this.maxFrames,n=this.maxFrames-i;t<=n?this.buffer.set(s,i):(this.buffer.set(s.subarray(0,n),i),this.buffer.set(s.subarray(n),0)),this.currentFrame+=t}read(e,t){if(e<0)throw new RangeError("startFrame must be non-negative");if(t<=e)return new Float32Array(0);const s=this.getBaseFrameOffset();if(e<s)throw new RangeError(`Requested frame ${e} has been overwritten. Oldest available: ${s}`);if(t>this.currentFrame)throw new RangeError(`Requested frame ${t} is in the future. Latest available: ${this.currentFrame}`);const i=t-e,n=new Float32Array(i),a=e%this.maxFrames,o=this.maxFrames-a;return i<=o?n.set(this.buffer.subarray(a,a+i)):(n.set(this.buffer.subarray(a,this.maxFrames)),n.set(this.buffer.subarray(0,i-o),o)),n}readInto(e,t,s){if(e<0)throw new RangeError("startFrame must be non-negative");if(t<=e)return 0;const i=this.getBaseFrameOffset();if(e<i)throw new RangeError(`Requested frame ${e} has been overwritten. Oldest available: ${i}`);if(t>this.currentFrame)throw new RangeError(`Requested frame ${t} is in the future. Latest available: ${this.currentFrame}`);const n=t-e,a=e%this.maxFrames,o=this.maxFrames-a;return n<=o?s.set(this.buffer.subarray(a,a+n)):(s.set(this.buffer.subarray(a,this.maxFrames)),s.set(this.buffer.subarray(0,n-o),o)),n}getCurrentFrame(){return this.currentFrame}getFillCount(){return Math.min(this.currentFrame,this.maxFrames)}getSize(){return this.maxFrames}getCurrentTime(){return this.currentFrame/this.sampleRate}getBaseFrameOffset(){return Math.max(0,this.currentFrame-this.maxFrames)}reset(){this.currentFrame=0,this.buffer.fill(0)}}const ir={medium:{audioThreshold:.08,silenceLength:.4}},ei=ir.medium.audioThreshold,ti=ir.medium.silenceLength,ri=.24,si=.16,ii=.24,ni=.08,oi=.12,ai=.08,li=3,ci=1,di=.05,hi=.15,ui=1,fi=.08,gi=6,pi=3,mi=20,vi=4.8,yi=16e3,me={audioThreshold:ei,silenceLength:ti,minSpeechDuration:ri,maxSilenceWithinSpeech:si,endingSpeechTolerance:ii,lookbackDuration:oi,overlapDuration:ai,snrThreshold:li,minSnrThreshold:ci,noiseFloorAdaptationRate:di,fastAdaptationRate:hi,minBackgroundDuration:ui,energyRiseThreshold:fi,smaLength:gi,lookbackChunks:pi,maxHistoryLength:mi,maxSegmentDuration:vi,sampleRate:yi};class Wt{options;state;constructor(e={}){const t=e.sampleRate??me.sampleRate??16e3;this.options={sampleRate:t,minSpeechDuration:me.minSpeechDuration,silenceThreshold:me.silenceLength,energyThreshold:me.audioThreshold,smaLength:me.smaLength,lookbackChunks:me.lookbackChunks,overlapDuration:me.overlapDuration,lookbackDuration:me.lookbackDuration,maxHistoryLength:me.maxHistoryLength,noiseFloorAdaptationRate:me.noiseFloorAdaptationRate,fastAdaptationRate:me.fastAdaptationRate,snrThreshold:me.snrThreshold,minBackgroundDuration:me.minBackgroundDuration,minSnrThreshold:me.minSnrThreshold,energyRiseThreshold:me.energyRiseThreshold,maxSegmentDuration:me.maxSegmentDuration,maxSilenceWithinSpeech:me.maxSilenceWithinSpeech,endingSpeechTolerance:me.endingSpeechTolerance,logger:console.log,...e,windowSize:Math.round(ni*(e.sampleRate??t))},this.log("Initialized AudioSegmentProcessor",{sampleRate:this.options.sampleRate,windowSize:this.options.windowSize,lookbackDuration:this.options.lookbackDuration,overlapDuration:this.options.overlapDuration,snrThreshold:this.options.snrThreshold,minSnrThreshold:this.options.minSnrThreshold}),this.reset()}log(e,t){typeof this.options.logger=="function"&&this.options.logger(`[AudioSegmentProcessor] ${e}`,t)}processAudioData(e,t,s){if(!e||!e.length)return[];const i=[],n=s>this.options.energyThreshold;if(n)this.state.silenceDuration=0;else{const o=e.length/this.options.sampleRate;this.state.silenceDuration+=o}this.updateNoiseFloor(s,n);const a=this.calculateSNR(s);if(this.state.recentChunks.push({time:t,energy:s,isSpeech:n,snr:a}),this.state.recentChunks.length>this.options.maxHistoryLength*10&&this.state.recentChunks.shift(),this.state.inSpeech&&this.state.speechStartTime!==null){const o=t-this.state.speechStartTime;if(o>this.options.maxSegmentDuration){this.log("Splitting long segment",{startTime:this.state.speechStartTime.toFixed(2),splitTime:t.toFixed(2),duration:o.toFixed(2)});const c=this.createSegment(this.state.speechStartTime,t);c&&i.push(c),this.startSpeech(t,s)}}if(!this.state.inSpeech&&n){const o=this.findSpeechStart(),c=o!==-1?this.state.recentChunks[o].time:t;this.startSpeech(c,s),this.log("Speech start detected",{detectedAt:t.toFixed(2),actualStart:c.toFixed(2),lookbackDiff:(t-c).toFixed(2),snr:a.toFixed(2),noiseFloor:this.state.noiseFloor.toFixed(6)})}else if(this.state.inSpeech&&!n){this.state.silenceCounter++;const o=Math.ceil(this.options.silenceThreshold/(this.options.windowSize/this.options.sampleRate));this.state.silenceCounter%5===0&&this.log("Silence progressing",{counter:this.state.silenceCounter,needed:o,energy:s.toFixed(6),snr:a.toFixed(2)});const c=this.state.silenceCounter*(this.options.windowSize/this.options.sampleRate),h=this.state.silenceCounter>=o;if(c<this.options.maxSilenceWithinSpeech)this.state.speechEnergies.push(s);else if(h){if(this.state.speechStartTime!==null){const d=t-this.state.speechStartTime,m=this.state.speechEnergies.length>0?this.state.speechEnergies.reduce((p,k)=>p+k,0)/this.state.speechEnergies.length:0;this.state.speechStats.push({startTime:this.state.speechStartTime,endTime:t,duration:d,avgEnergy:m,energyIntegral:m*d}),this.state.speechStats.length>this.options.maxHistoryLength&&this.state.speechStats.shift()}const u=this.createSegment(this.state.speechStartTime,t);u&&i.push(u),this.startSilence(t)}else this.state.silenceEnergies.push(s)}else this.state.inSpeech?this.state.speechEnergies.push(s):this.state.silenceEnergies.push(s);return this.updateStats(),i}updateNoiseFloor(e,t){if(!t){let s=this.options.noiseFloorAdaptationRate;if(this.state.silenceDuration<this.options.minBackgroundDuration){const i=Math.min(1,this.state.silenceDuration/this.options.minBackgroundDuration);s=this.options.fastAdaptationRate*(1-i)+this.options.noiseFloorAdaptationRate*i}this.state.noiseFloor=this.state.noiseFloor*(1-s)+e*s,this.state.noiseFloor=Math.max(1e-5,this.state.noiseFloor)}this.state.recentEnergies.push(e),this.state.recentEnergies.length>50&&this.state.recentEnergies.shift()}calculateSNR(e){const t=Math.max(1e-4,this.state.noiseFloor);return 10*Math.log10(e/t)}startSpeech(e,t){this.state.inSpeech=!0,this.state.speechStartTime=e,this.state.silenceCounter=0,this.state.speechEnergies=[t],this.state.silenceStartTime=null,this.state.silenceDuration=0;const s=this.calculateSNR(t);this.log("Speech state started",{time:e.toFixed(2),energy:t.toFixed(6),snr:s.toFixed(2),noiseFloor:this.state.noiseFloor.toFixed(6)})}startSilence(e){this.state.inSpeech=!1,this.state.silenceStartTime=e,this.state.speechStartTime=null,this.state.silenceCounter=0,this.state.silenceEnergies=[],this.state.silenceDuration=.001,this.log("Silence state started",{time:e.toFixed(2),noiseFloor:this.state.noiseFloor.toFixed(6)})}findSpeechStart(){const e=this.state.recentChunks,t=this.options.minSnrThreshold;let s=0;for(let a=e.length-1;a>=0;a--)if(e[a].isSpeech){s=a;break}let i=s,n=!1;for(let a=s-1;a>=0&&(a<e.length-1&&e[a+1].energy>e[a].energy*(1+this.options.energyRiseThreshold)&&(i=a,n=!0),!(e[a].snr<t/2||s-a>6));a--);if(n)return this.log("Found rising energy trend for speech onset",{index:i,time:e[i].time.toFixed(3),energy:e[i].energy.toFixed(6),snr:e[i].snr.toFixed(2)}),i;for(let a=s;a>=0;a--)if(e[a].snr<t)return Math.min(e.length-1,a+1);return Math.max(0,s-4)}createSegment(e,t){const s=t-e;return s<=0?(this.log("Skipping segment with zero/negative duration"),null):{startTime:e,endTime:t,duration:s}}updateStats(){const e={silence:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},speech:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},noiseFloor:this.state.noiseFloor,snr:this.state.recentChunks.length>0?this.state.recentChunks[this.state.recentChunks.length-1].snr:0,snrThreshold:this.options.snrThreshold,minSnrThreshold:this.options.minSnrThreshold,energyRiseThreshold:this.options.energyRiseThreshold};this.state.silenceStats.length>0&&(e.silence={avgDuration:this.average(this.state.silenceStats.map(t=>t.duration)),avgEnergy:this.average(this.state.silenceStats.map(t=>t.avgEnergy)),avgEnergyIntegral:this.average(this.state.silenceStats.map(t=>t.energyIntegral))}),this.state.speechStats.length>0&&(e.speech={avgDuration:this.average(this.state.speechStats.map(t=>t.duration)),avgEnergy:this.average(this.state.speechStats.map(t=>t.avgEnergy)),avgEnergyIntegral:this.average(this.state.speechStats.map(t=>t.energyIntegral))}),this.state.currentStats=e}average(e){return e.length===0?0:e.reduce((t,s)=>t+s,0)/e.length}getStats(){return this.state.currentStats}getStateInfo(){return{inSpeech:this.state.inSpeech,noiseFloor:this.state.noiseFloor,snr:this.state.currentStats.snr,speechStartTime:this.state.speechStartTime}}reset(){this.state={inSpeech:!1,speechStartTime:null,silenceStartTime:null,silenceCounter:0,recentChunks:[],speechEnergies:[],silenceEnergies:[],speechStats:[],silenceStats:[],currentStats:{silence:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},speech:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},noiseFloor:.005,snr:0,snrThreshold:this.options.snrThreshold,minSnrThreshold:this.options.minSnrThreshold,energyRiseThreshold:this.options.energyRiseThreshold},segmentCounter:0,noiseFloor:.005,recentEnergies:[],silenceDuration:0}}setThreshold(e){this.options.energyThreshold=e,this.log("Updated energy threshold",e)}setSilenceLength(e){this.options.silenceThreshold=e,this.log("Updated silence threshold",e)}setLookbackDuration(e){this.options.lookbackDuration=e,this.log("Updated lookback duration",e)}setOverlapDuration(e){this.options.overlapDuration=e,this.log("Updated overlap duration",e)}setSnrThreshold(e){this.options.snrThreshold=e,this.log("Updated SNR threshold",e)}setMinSnrThreshold(e){this.options.minSnrThreshold=e,this.log("Updated minimum SNR threshold",e)}setNoiseFloorAdaptationRate(e){this.options.noiseFloorAdaptationRate=e,this.log("Updated noise floor adaptation rate",e)}setFastAdaptationRate(e){this.options.fastAdaptationRate=e,this.log("Updated fast adaptation rate",e)}setEnergyRiseThreshold(e){this.options.energyRiseThreshold=e,this.log("Updated energy rise threshold",e)}setMinBackgroundDuration(e){this.options.minBackgroundDuration=e,this.log("Updated minimum background duration",e)}setMaxSegmentDuration(e){this.options.maxSegmentDuration=e,this.log("Updated maximum segment duration",e)}setMinSpeechDuration(e){this.options.minSpeechDuration=e,this.log("Updated minimum speech duration",e)}setMaxSilenceWithinSpeech(e){this.options.maxSilenceWithinSpeech=e,this.log("Updated max silence within speech",e)}setEndingSpeechTolerance(e){this.options.endingSpeechTolerance=e,this.log("Updated ending speech tolerance",e)}}function bi(r,e,t){if(e===t)return r;const s=e/t,i=Math.floor(r.length/s),n=new Float32Array(i);for(let a=0;a<i;a++){const o=a*s,c=Math.floor(o),h=Math.min(c+1,r.length-1),u=o-c;n[a]=r[c]*(1-u)+r[h]*u}return n}const Ut=30;class Si{config;ringBuffer;audioProcessor;deviceId=null;audioContext=null;mediaStream=null;workletNode=null;sourceNode=null;analyserNode=null;analyserSourceNode=null;analyserGainNode=null;analyserTimeBuffer=null;waveformOut=null;ANALYSER_FFT_SIZE=256;ANALYSER_SMOOTHING=.3;deviceSampleRate=48e3;targetSampleRate=16e3;currentEnergy=0;segmentCallbacks=[];windowCallbacks=[];audioChunkCallbacks=[];energyHistory=[];energyBarHistory=[];BAR_LEVELS_SIZE=64;visualizationSummary=null;visualizationSummaryPosition=0;VIS_SUMMARY_SIZE=2e3;visualizationBuffer=null;visualizationBufferPosition=0;visualizationBufferSize=0;metrics={currentEnergy:0,averageEnergy:0,peakEnergy:0,noiseFloor:.01,currentSNR:0,isSpeaking:!1};visualizationCallbacks=[];lastVisualizationNotifyTime=0;VISUALIZATION_NOTIFY_INTERVAL_MS=16;recentSegments=[];MAX_SEGMENTS_FOR_VISUALIZATION=50;constructor(e={}){this.config={sampleRate:16e3,bufferDuration:120,energyThreshold:.08,minSpeechDuration:240,minSilenceDuration:400,maxSegmentDuration:4.8,lookbackDuration:.12,speechHangover:.16,minEnergyIntegral:22,minEnergyPerSecond:5,useAdaptiveEnergyThresholds:!0,adaptiveEnergyIntegralFactor:25,adaptiveEnergyPerSecondFactor:10,minAdaptiveEnergyIntegral:3,minAdaptiveEnergyPerSecond:1,maxSilenceWithinSpeech:.16,endingSpeechTolerance:.24,...e},this.deviceId=this.config.deviceId||null,this.targetSampleRate=this.config.sampleRate,this.ringBuffer=new Ot(this.targetSampleRate,this.config.bufferDuration),this.audioProcessor=new Wt({sampleRate:this.targetSampleRate,energyThreshold:this.config.energyThreshold,minSpeechDuration:this.config.minSpeechDuration,silenceThreshold:this.config.minSilenceDuration,maxSegmentDuration:this.config.maxSegmentDuration,lookbackDuration:this.config.lookbackDuration,maxSilenceWithinSpeech:this.config.maxSilenceWithinSpeech,endingSpeechTolerance:this.config.endingSpeechTolerance,snrThreshold:3,minSnrThreshold:1,noiseFloorAdaptationRate:.05,fastAdaptationRate:.15,minBackgroundDuration:1,energyRiseThreshold:.08}),this.visualizationBufferSize=Math.round(this.targetSampleRate*Ut),this.visualizationBuffer=new Float32Array(this.visualizationBufferSize),this.visualizationBufferPosition=0,this.visualizationSummary=new Float32Array(this.VIS_SUMMARY_SIZE*2),this.visualizationSummaryPosition=0,console.log("[AudioEngine] Initialized with config:",this.config)}isWorkletInitialized=!1;async init(){try{this.mediaStream&&this.mediaStream.getTracks().forEach(i=>i.stop());const s={audio:{deviceId:this.deviceId?{exact:this.deviceId}:void 0,channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}};console.log("[AudioEngine] Requesting microphone:",s),this.mediaStream=await navigator.mediaDevices.getUserMedia(s),console.log("[AudioEngine] Microphone stream acquired:",this.mediaStream.id)}catch(s){throw console.error("[AudioEngine] Failed to get media stream:",s),s}const t=this.mediaStream.getAudioTracks()[0]?.getSettings?.();if(this.deviceSampleRate=t?.sampleRate??48e3,console.log("[AudioEngine] Device sample rate:",this.deviceSampleRate,"-> Target:",this.targetSampleRate),this.audioContext&&this.audioContext.sampleRate!==this.deviceSampleRate&&(await this.audioContext.close(),this.audioContext=null),this.audioContext||(this.audioContext=new AudioContext({sampleRate:this.deviceSampleRate,latencyHint:"interactive"}),console.log("[AudioEngine] Created AudioContext:",this.audioContext.state,"sampleRate:",this.audioContext.sampleRate)),this.ringBuffer=new Ot(this.targetSampleRate,this.config.bufferDuration),this.audioProcessor=new Wt({sampleRate:this.targetSampleRate,energyThreshold:this.config.energyThreshold,minSpeechDuration:this.config.minSpeechDuration,silenceThreshold:this.config.minSilenceDuration,maxSegmentDuration:this.config.maxSegmentDuration}),!this.isWorkletInitialized){const i=`
                class CaptureProcessor extends AudioWorkletProcessor {
                    constructor(options) {
                        super(options);
                        const opts = options?.processorOptions || {};
                        this.inputSampleRate = opts.inputSampleRate || 16000;
                        this.targetSampleRate = opts.targetSampleRate || this.inputSampleRate;
                        this.ratio = this.inputSampleRate / this.targetSampleRate;
                        this.bufferSize = Math.round(${.08} * this.inputSampleRate);
                        this.buffer = new Float32Array(this.bufferSize);
                        this.index = 0;
                        this._lastLog = 0;
                    }

                    _emitChunk() {
                        let out;
                        let maxAbs = 0;

                        if (this.targetSampleRate === this.inputSampleRate) {
                            out = new Float32Array(this.bufferSize);
                            for (let i = 0; i < this.bufferSize; i++) {
                                const v = this.buffer[i];
                                out[i] = v;
                                const a = v < 0 ? -v : v;
                                if (a > maxAbs) maxAbs = a;
                            }
                        } else {
                            const outLength = Math.floor(this.bufferSize / this.ratio);
                            out = new Float32Array(outLength);
                            for (let i = 0; i < outLength; i++) {
                                const srcIndex = i * this.ratio;
                                const srcIndexFloor = Math.floor(srcIndex);
                                const srcIndexCeil = Math.min(srcIndexFloor + 1, this.bufferSize - 1);
                                const t = srcIndex - srcIndexFloor;
                                const v = this.buffer[srcIndexFloor] * (1 - t) + this.buffer[srcIndexCeil] * t;
                                out[i] = v;
                                const a = v < 0 ? -v : v;
                                if (a > maxAbs) maxAbs = a;
                            }
                        }

                        this.port.postMessage(
                            { type: 'audio', samples: out, sampleRate: this.targetSampleRate, maxAbs },
                            [out.buffer]
                        );
                    }

                    process(inputs) {
                        const input = inputs[0];
                        if (!input || !input[0]) return true;
                        
                        const channelData = input[0];
                        
                        // Buffer the data
                        for (let i = 0; i < channelData.length; i++) {
                            this.buffer[this.index++] = channelData[i];
                            
                            if (this.index >= this.bufferSize) {
                                this._emitChunk();
                                this.index = 0;
                                
                                // Debug log every ~5 seconds
                                const now = Date.now();
                                if (now - this._lastLog > 5000) {
                                    this.port.postMessage({ type: 'log', message: '[AudioWorklet] Active' });
                                    this._lastLog = now;
                                }
                            }
                        }
                        
                        return true;
                    }
                }
                registerProcessor('capture-processor', CaptureProcessor);
            `,n=new Blob([i],{type:"application/javascript"}),a=URL.createObjectURL(n);try{await this.audioContext.audioWorklet.addModule(a),this.isWorkletInitialized=!0,console.log("[AudioEngine] AudioWorklet module loaded")}catch(o){console.error("[AudioEngine] Failed to load worklet:",o),o instanceof Error&&o.name==="InvalidStateError"&&(this.isWorkletInitialized=!0)}}this.workletNode&&this.workletNode.disconnect(),this.workletNode=new AudioWorkletNode(this.audioContext,"capture-processor",{processorOptions:{inputSampleRate:this.deviceSampleRate,targetSampleRate:this.targetSampleRate}}),this.workletNode.port.onmessage=s=>{s.data?.type==="audio"&&s.data.samples instanceof Float32Array?this.handleAudioChunk(s.data.samples,s.data.maxAbs,s.data.sampleRate):s.data instanceof Float32Array?this.handleAudioChunk(s.data,void 0,this.deviceSampleRate):s.data?.type==="log"&&console.log(s.data.message)},this.workletNode.onprocessorerror=s=>{console.error("[AudioEngine] Worklet processor error:",s)},this.sourceNode?.disconnect(),this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),this.sourceNode.connect(this.workletNode),this.disposeAnalyser(),this.analyserSourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),this.analyserNode=this.audioContext.createAnalyser(),this.analyserNode.fftSize=this.ANALYSER_FFT_SIZE,this.analyserNode.smoothingTimeConstant=this.ANALYSER_SMOOTHING,this.analyserTimeBuffer=new Uint8Array(this.analyserNode.fftSize),this.waveformOut=new Float32Array(this.analyserNode.fftSize),this.analyserGainNode=this.audioContext.createGain(),this.analyserGainNode.gain.value=0,this.analyserSourceNode.connect(this.analyserNode),this.analyserNode.connect(this.analyserGainNode),this.analyserGainNode.connect(this.audioContext.destination),this.workletNode.connect(this.audioContext.destination),console.log("[AudioEngine] Graph connected: Source -> Worklet, AnalyserNode for oscilloscope")}async start(){(!this.mediaStream||!this.audioContext||!this.workletNode)&&await this.init(),this.audioContext?.state==="suspended"&&await this.audioContext.resume()}stop(){this.audioContext?.state==="running"&&this.audioContext.suspend()}reset(){this.ringBuffer.reset(),this.audioProcessor.reset(),this.currentEnergy=0,this.metrics={currentEnergy:0,averageEnergy:0,peakEnergy:0,noiseFloor:.01,currentSNR:0,isSpeaking:!1},this.recentSegments=[],this.energyBarHistory=[],this.visualizationBuffer&&this.visualizationBuffer.fill(0),this.visualizationBufferPosition=0;for(const e of this.windowCallbacks)e.lastWindowEnd=0;this.notifyVisualizationUpdate()}getCurrentEnergy(){return this.currentEnergy}getBarLevels(){if(this.analyserNode&&this.analyserTimeBuffer&&this.waveformOut){this.analyserNode.getByteTimeDomainData(this.analyserTimeBuffer);for(let i=0;i<this.analyserTimeBuffer.length;i++)this.waveformOut[i]=(this.analyserTimeBuffer[i]-128)/128;return this.waveformOut}const e=new Float32Array(this.BAR_LEVELS_SIZE),t=this.energyBarHistory,s=t.length<=this.BAR_LEVELS_SIZE?0:t.length-this.BAR_LEVELS_SIZE;for(let i=0;i<this.BAR_LEVELS_SIZE;i++){const n=s+i;e[i]=n<t.length?Math.min(1,Math.max(0,t[n])):0}return e}getSignalMetrics(){const e=this.audioProcessor.getStats();return{noiseFloor:e.noiseFloor??1e-4,snr:e.snr??0,threshold:this.config.energyThreshold,snrThreshold:e.snrThreshold??3}}isSpeechActive(){return this.audioProcessor.getStateInfo().inSpeech}getRingBuffer(){return this.ringBuffer}onSpeechSegment(e){return this.segmentCallbacks.push(e),()=>{this.segmentCallbacks=this.segmentCallbacks.filter(t=>t!==e)}}onWindowChunk(e,t,s,i){const n={windowDuration:e,overlapDuration:t,triggerInterval:s,callback:i,lastWindowEnd:0};return this.windowCallbacks.push(n),()=>{this.windowCallbacks=this.windowCallbacks.filter(a=>a!==n)}}onAudioChunk(e){return this.audioChunkCallbacks.push(e),()=>{this.audioChunkCallbacks=this.audioChunkCallbacks.filter(t=>t!==e)}}updateConfig(e){this.config={...this.config,...e},e.energyThreshold!==void 0&&this.audioProcessor.setThreshold(e.energyThreshold),e.minSpeechDuration!==void 0&&this.audioProcessor.setMinSpeechDuration(e.minSpeechDuration),e.minSilenceDuration!==void 0&&this.audioProcessor.setSilenceLength(e.minSilenceDuration),e.maxSegmentDuration!==void 0&&this.audioProcessor.setMaxSegmentDuration(e.maxSegmentDuration),e.lookbackDuration!==void 0&&this.audioProcessor.setLookbackDuration(e.lookbackDuration),e.overlapDuration!==void 0&&this.audioProcessor.setOverlapDuration(e.overlapDuration),e.maxSilenceWithinSpeech!==void 0&&this.audioProcessor.setMaxSilenceWithinSpeech(e.maxSilenceWithinSpeech),e.endingSpeechTolerance!==void 0&&this.audioProcessor.setEndingSpeechTolerance(e.endingSpeechTolerance),e.snrThreshold!==void 0&&this.audioProcessor.setSnrThreshold(e.snrThreshold),e.minSnrThreshold!==void 0&&this.audioProcessor.setMinSnrThreshold(e.minSnrThreshold)}async setDevice(e){this.deviceId=e,await this.init(),this.audioContext&&this.workletNode&&(this.sourceNode?.disconnect(),this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),this.sourceNode.connect(this.workletNode))}disposeAnalyser(){this.analyserSourceNode?.disconnect(),this.analyserNode?.disconnect(),this.analyserGainNode?.disconnect(),this.analyserSourceNode=null,this.analyserNode=null,this.analyserGainNode=null,this.analyserTimeBuffer=null,this.waveformOut=null}dispose(){this.stop(),this.disposeAnalyser(),this.mediaStream?.getTracks().forEach(e=>e.stop()),this.audioContext?.close(),this.audioContext=null,this.mediaStream=null,this.workletNode=null,this.sourceNode=null}handleAudioChunk(e,t,s){const i=s??this.targetSampleRate,n=i!==this.targetSampleRate,a=n?bi(e,i,this.targetSampleRate):e;let o=!n&&t!==void 0?t:0;if(t===void 0||n)for(let E=0;E<a.length;E++){const x=Math.abs(a[E]);x>o&&(o=x)}this.energyHistory.push(o),this.energyHistory.length>6&&this.energyHistory.shift();const c=this.energyHistory.reduce((E,x)=>E+x,0)/this.energyHistory.length;this.currentEnergy=c,this.energyBarHistory.push(c),this.energyBarHistory.length>this.BAR_LEVELS_SIZE&&this.energyBarHistory.shift();const h=c>this.config.energyThreshold,u=this.metrics.isSpeaking;h!==u&&console.debug(`[AudioEngine] Energy threshold crossed: ${c.toFixed(6)} > ${this.config.energyThreshold} = ${h}`),this.ringBuffer.write(a);const d=this.ringBuffer.getCurrentFrame(),m=this.ringBuffer.getCurrentTime(),p=this.audioProcessor.processAudioData(a,m,c);this.updateVisualizationBuffer(a);const k=this.audioProcessor.getStats(),_=this.audioProcessor.getStateInfo();if(this.metrics.currentEnergy=c,this.metrics.averageEnergy=this.metrics.averageEnergy*.95+c*.05,this.metrics.peakEnergy=Math.max(this.metrics.peakEnergy*.99,c),this.metrics.noiseFloor=k.noiseFloor??.01,this.metrics.currentSNR=k.snr??0,this.metrics.isSpeaking=_.inSpeech,Math.random()<.05&&console.debug(`[AudioEngine] Metrics: E=${c.toFixed(6)}, NF=${this.metrics.noiseFloor.toFixed(6)}, SNR=${this.metrics.currentSNR.toFixed(2)}, Speaking=${this.metrics.isSpeaking}`),p.length>0)for(const E of p){const x=this.config.lookbackDuration??.12,S=Math.max(0,E.startTime-x),y=Math.round(S*this.targetSampleRate),z=Math.round(E.endTime*this.targetSampleRate),R=this.config.speechHangover??.16,G=Math.min(this.ringBuffer.getCurrentFrame(),z+Math.round(R*this.targetSampleRate));try{const X=this.ringBuffer.read(y,G),J=this.calculateSegmentEnergyMetrics(X,this.targetSampleRate),ce=J.averagePower*16e3,ge=ce*J.duration;let ye=this.config.minEnergyIntegral??22,C=this.config.minEnergyPerSecond??5;if(this.config.useAdaptiveEnergyThresholds){const L=this.config.windowSize??Math.round(.08*this.targetSampleRate),Q=(L>0?this.metrics.noiseFloor/L:0)*16e3,v=Q*(this.config.adaptiveEnergyIntegralFactor??25);ye=Math.max(this.config.minAdaptiveEnergyIntegral??3,v);const T=Q*(this.config.adaptiveEnergyPerSecondFactor??10);C=Math.max(this.config.minAdaptiveEnergyPerSecond??1,T)}if(J.duration>=this.config.minSpeechDuration/1e3&&ce>=C&&ge>=ye){const L={startFrame:y,endFrame:G,duration:J.duration,averageEnergy:J.averagePower,timestamp:Date.now()};this.notifySegment(L)}else console.log("[AudioEngine] Filtered out noise segment:",{duration:J.duration,power:ce,integral:ge})}catch(X){console.warn("[AudioEngine] Failed to extract audio for validation:",X)}}this.processWindowCallbacks(d);for(const E of this.audioChunkCallbacks)E(a);this.notifyVisualizationUpdate()}calculateSegmentEnergyMetrics(e,t){if(!e||e.length===0)return{averagePower:0,duration:0,numSamples:0};const s=e.length;let i=0;for(let o=0;o<s;o++)i+=e[o]*e[o];const n=s/t;return{averagePower:s>0?i/s:0,duration:n,numSamples:s}}processWindowCallbacks(e){for(const t of this.windowCallbacks){const s=Math.floor(t.windowDuration*this.targetSampleRate),i=Math.floor(t.triggerInterval*this.targetSampleRate);if(t.lastWindowEnd===0){t.lastWindowEnd=e;continue}if(e-t.lastWindowEnd>=i){const a=e,o=a-s,c=this.ringBuffer.getBaseFrameOffset();if(o>=c)try{const h=this.ringBuffer.read(o,a),u=o/this.targetSampleRate;t.callback(h,u),t.lastWindowEnd=a}catch(h){console.warn("[AudioEngine] Window read failed:",h)}}}}notifySegment(e){this.recentSegments.push({startTime:e.startFrame/this.targetSampleRate,endTime:e.endFrame/this.targetSampleRate,isProcessed:!1}),this.recentSegments.length>this.MAX_SEGMENTS_FOR_VISUALIZATION&&this.recentSegments.shift(),this.segmentCallbacks.forEach(t=>t(e))}getSegmentsForVisualization(){const e=[...this.recentSegments],t=this.audioProcessor.getStateInfo();return t.inSpeech&&t.speechStartTime!==null&&e.push({startTime:t.speechStartTime,endTime:this.ringBuffer.getCurrentTime(),isProcessed:!1}),e}markSegmentProcessed(e){const t=this.recentSegments.find(s=>Math.abs(s.startTime-e)<.1);t&&(t.isProcessed=!0)}updateVisualizationBuffer(e){if(!this.visualizationBuffer||!this.visualizationSummary)return;const t=e.length,s=this.visualizationBufferSize;if(t>=s)this.visualizationBuffer.set(e.subarray(t-s)),this.visualizationBufferPosition=0;else{const a=this.visualizationBufferPosition+t;if(a<=s)this.visualizationBuffer.set(e,this.visualizationBufferPosition),this.visualizationBufferPosition=a%s;else{const o=s-this.visualizationBufferPosition;this.visualizationBuffer.set(e.subarray(0,o),this.visualizationBufferPosition),this.visualizationBuffer.set(e.subarray(o),0),this.visualizationBufferPosition=(t-o)%s}}const i=s/this.VIS_SUMMARY_SIZE,n=Math.round(t/i);for(let a=0;a<n;a++){const o=Math.floor(a*i),c=Math.min(t,Math.floor((a+1)*i));if(o>=c)continue;let h=e[o],u=e[o];for(let m=o+1;m<c;m++){const p=e[m];p<h&&(h=p),p>u&&(u=p)}const d=this.visualizationSummaryPosition*2;this.visualizationSummary[d]=h,this.visualizationSummary[d+1]=u,this.visualizationSummaryPosition=(this.visualizationSummaryPosition+1)%this.VIS_SUMMARY_SIZE}}getVisualizationData(e){if(!this.visualizationSummary||!e||e<=0)return new Float32Array(0);if(e<=this.VIS_SUMMARY_SIZE){const t=new Float32Array(e*2),s=this.VIS_SUMMARY_SIZE/e;for(let i=0;i<e;i++){const n=i*s,a=(i+1)*s;let o=0,c=0,h=!0;for(let u=Math.floor(n);u<Math.floor(a);u++){const d=(this.visualizationSummaryPosition+u)%this.VIS_SUMMARY_SIZE*2,m=this.visualizationSummary[d],p=this.visualizationSummary[d+1];h?(o=m,c=p,h=!1):(m<o&&(o=m),p>c&&(c=p))}t[i*2]=o,t[i*2+1]=c}return t}return this.getVisualizationDataFromRaw(e)}getVisualizationDataFromRaw(e){if(!this.visualizationBuffer)return new Float32Array(0);const t=this.visualizationBuffer,s=this.visualizationBufferSize,i=this.visualizationBufferPosition,n=s/e,a=new Float32Array(e*2),o=s-i;for(let c=0;c<e;c++){const h=Math.floor(c*n),u=Math.floor((c+1)*n);let d=0,m=0,p=!0;const k=u<o?u:o;if(h<k){let E=i+h;const x=i+k;if(p&&E<x){const S=t[E];d=S,m=S,p=!1,E++}for(;E<x;E++){const S=t[E];S<d?d=S:S>m&&(m=S)}}const _=h>o?h:o;if(_<u){let E=_-o;const x=u-o;if(p&&E<x){const S=t[E];d=S,m=S,p=!1,E++}for(;E<x;E++){const S=t[E];S<d?d=S:S>m&&(m=S)}}a[c*2]=d,a[c*2+1]=m}return a}getMetrics(){return{...this.metrics}}getCurrentTime(){return this.ringBuffer.getCurrentTime()}getVisualizationDuration(){return Ut}onVisualizationUpdate(e){return this.visualizationCallbacks.push(e),()=>{this.visualizationCallbacks=this.visualizationCallbacks.filter(t=>t!==e)}}notifyVisualizationUpdate(){const e=performance.now();if(e-this.lastVisualizationNotifyTime<this.VISUALIZATION_NOTIFY_INTERVAL_MS)return;this.lastVisualizationNotifyTime=e;const t=this.getVisualizationData(400),s=this.ringBuffer.getCurrentTime();this.visualizationCallbacks.forEach(i=>i(t,this.getMetrics(),s))}}class Ht{worker;messageId=0;pendingPromises=new Map;initFailed=!1;constructor(){this.worker=new Worker(new URL("/keet/assets/mel.worker-CasznYT3.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleMessage(e)},this.worker.onerror=e=>{const t=e,s=t.message||"Worker failed to load",i=t.filename?` at ${t.filename}:${t.lineno}:${t.colno}`:"";console.error(`[MelWorkerClient] Worker error: ${s}${i}`,e),this.initFailed=!0;for(const[,n]of this.pendingPromises)n.reject(new Error(`[MelWorkerClient] ${s}${i}`));this.pendingPromises.clear()}}async init(e={}){if(this.initFailed)throw new Error("[MelWorkerClient] Worker failed to load");await this.sendRequest("INIT",e)}pushAudio(e){this.initFailed||this.worker.postMessage({type:"PUSH_AUDIO",payload:e},[e.buffer])}pushAudioCopy(e){if(this.initFailed)return;const t=new Float32Array(e);this.worker.postMessage({type:"PUSH_AUDIO",payload:t},[t.buffer])}async getFeatures(e,t,s=!0){return this.sendRequest("GET_FEATURES",{startSample:e,endSample:t,normalize:s})}async getLastMelFrame(){const e=await this.sendRequest("GET_LAST_MEL_FRAME",{});return e&&e.melFrame?e.melFrame:null}async getStatus(){return this.sendRequest("GET_STATUS",{})}async reset(){return this.sendRequest("RESET",{})}dispose(){this.worker.terminate();for(const[,e]of this.pendingPromises)e.reject(new Error("MelWorkerClient disposed"));this.pendingPromises.clear()}handleMessage(e){const{type:t,payload:s,id:i}=e.data;if(t==="ERROR"){const n=this.pendingPromises.get(i);n&&(this.pendingPromises.delete(i),n.reject(new Error(s)));return}if(i!==void 0){const n=this.pendingPromises.get(i);n&&(this.pendingPromises.delete(i),n.resolve(s))}}sendRequest(e,t){return new Promise((s,i)=>{if(this.initFailed){i(new Error("MelWorkerClient: worker failed to load"));return}const n=++this.messageId;this.pendingPromises.set(n,{resolve:s,reject:i}),this.worker.postMessage({type:e,payload:t,id:n})})}}class xi{worker;messageId=0;pendingPromises=new Map;onModelProgress;onModelStateChange;onV3Confirmed;onV3Pending;onError;constructor(){this.worker=new Worker(new URL("/keet/assets/transcription.worker-CcGxx9PS.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>this.handleMessage(e.data),this.worker.onerror=e=>{console.error("[TranscriptionWorkerClient] Fatal Worker Error:",e),this.onError?.("Fatal background worker error")}}handleMessage(e){const{type:t,payload:s,id:i}=e;if(i!==void 0&&this.pendingPromises.has(i)){const{resolve:n,reject:a}=this.pendingPromises.get(i);this.pendingPromises.delete(i),t==="ERROR"?a(new Error(s)):n(s);return}switch(t){case"MODEL_PROGRESS":this.onModelProgress?.(s);break;case"MODEL_STATE":this.onModelStateChange?.(s);break;case"V3_CONFIRMED":this.onV3Confirmed?.(s.text,s.words);break;case"V3_PENDING":this.onV3Pending?.(s.text,s.words);break;case"ERROR":this.onError?.(s);break}}sendRequest(e,t){const s=this.messageId++;return new Promise((i,n)=>{this.pendingPromises.set(s,{resolve:i,reject:n}),this.worker.postMessage({type:e,payload:t,id:s})})}async initModel(e){return this.sendRequest("INIT_MODEL",{modelId:e})}async initLocalModel(e){return this.sendRequest("LOAD_LOCAL_MODEL",Array.from(e))}async initService(e){return this.sendRequest("INIT_SERVICE",{config:e})}async initV3Service(e){return this.sendRequest("INIT_V3_SERVICE",{config:e})}async processChunk(e){return this.sendRequest("PROCESS_CHUNK",e)}async processV3Chunk(e,t){return this.sendRequest("PROCESS_V3_CHUNK",{audio:e,startTime:t})}async processV3ChunkWithFeatures(e,t,s,i,n){return this.sendRequest("PROCESS_V3_CHUNK_WITH_FEATURES",{features:e,T:t,melBins:s,startTime:i,overlapSeconds:n})}async transcribeSegment(e){return this.sendRequest("TRANSCRIBE_SEGMENT",e)}async reset(){return this.sendRequest("RESET")}async finalize(){return this.sendRequest("FINALIZE")}async initV4Service(e){return this.sendRequest("INIT_V4_SERVICE",{config:e||{}})}async processV4ChunkWithFeatures(e){return this.sendRequest("PROCESS_V4_CHUNK_WITH_FEATURES",e)}async v4FinalizeTimeout(){return this.sendRequest("V4_FINALIZE_TIMEOUT")}async v4Reset(){return this.sendRequest("V4_RESET")}dispose(){this.worker.terminate(),this.pendingPromises.clear()}}class wi{config;isSpeechActive=!1;speechConfirmationCounter=0;silenceConfirmationCounter=0;minSpeechFrames;minSilenceFrames;noiseFloor=.005;snr=0;silenceDuration=0;noiseFloorAdaptationRate=.05;fastAdaptationRate=.15;minBackgroundDuration=1;snrThreshold=3;constructor(e={}){this.config={energyThreshold:.02,minSpeechDuration:100,minSilenceDuration:300,sampleRate:16e3,...e},this.minSpeechFrames=Math.ceil(this.config.minSpeechDuration/1e3*this.config.sampleRate),this.minSilenceFrames=Math.ceil(this.config.minSilenceDuration/1e3*this.config.sampleRate)}process(e){let t=0;for(let p=0;p<e.length;p++)t+=e[p]*e[p];const s=Math.sqrt(t/e.length),i=Date.now(),n=e.length/this.config.sampleRate,a=Math.max(1e-4,this.noiseFloor);this.snr=10*Math.log10(s/a);const o=this.snr>this.snrThreshold,c=s>this.config.energyThreshold,h=o||c;if(h)this.silenceDuration=0;else{this.silenceDuration+=n;let p=this.noiseFloorAdaptationRate;if(this.silenceDuration<this.minBackgroundDuration){const k=Math.min(1,this.silenceDuration/this.minBackgroundDuration);p=this.fastAdaptationRate*(1-k)+this.noiseFloorAdaptationRate*k}this.noiseFloor=this.noiseFloor*(1-p)+s*p,this.noiseFloor=Math.max(1e-5,this.noiseFloor)}const u=e.length;let d=!1,m=!1;return h?(this.silenceConfirmationCounter=0,this.isSpeechActive||(this.speechConfirmationCounter+=u,this.speechConfirmationCounter>=this.minSpeechFrames&&(this.isSpeechActive=!0,d=!0))):(this.speechConfirmationCounter=0,this.isSpeechActive&&(this.silenceConfirmationCounter+=u,this.silenceConfirmationCounter>=this.minSilenceFrames&&(this.isSpeechActive=!1,m=!0,this.silenceConfirmationCounter=0))),{isSpeech:this.isSpeechActive,energy:s,timestamp:i,speechStart:d,speechEnd:m,noiseFloor:this.noiseFloor,snr:this.snr}}reset(){this.isSpeechActive=!1,this.speechConfirmationCounter=0,this.silenceConfirmationCounter=0,this.noiseFloor=.005,this.snr=0,this.silenceDuration=0}updateConfig(e){this.config={...this.config,...e},this.minSpeechFrames=Math.ceil(this.config.minSpeechDuration/1e3*this.config.sampleRate),this.minSilenceFrames=Math.ceil(this.config.minSilenceDuration/1e3*this.config.sampleRate)}getConfig(){return{...this.config}}}class Ci{config;session=null;initialized=!1;stateH=null;stateC=null;srTensor=null;hopSize;contextSize;contextBuffer;constructor(e={}){this.config={modelUrl:"https://huggingface.co/onnx-community/silero-vad/resolve/main/onnx/model.onnx",threshold:.5,negThreshold:e.threshold!==void 0?e.threshold-.15:.35,sampleRate:16e3,...e},this.hopSize=this.config.sampleRate===16e3?512:256,this.contextSize=this.config.sampleRate===16e3?64:32,this.contextBuffer=new Float32Array(this.contextSize)}async init(e){if(this.initialized)return;const t=e||this.config.modelUrl,s=typeof ort<"u"?ort:globalThis.ort;if(!s)throw new Error("onnxruntime-web (ort) not found. Ensure parakeet.js backend is initialized first.");this.session=await s.InferenceSession.create(t,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),this.stateH=new s.Tensor("float32",new Float32Array(256),[2,1,128]),this.srTensor=new s.Tensor("int64",BigInt64Array.from([BigInt(this.config.sampleRate)]),[1]),this.initialized=!0}async process(e){if(!this.initialized||!this.session)throw new Error("SileroVAD not initialized. Call init() first.");const t=typeof ort<"u"?ort:globalThis.ort,s=this.contextSize+this.hopSize,i=new Float32Array(s);if(i.set(this.contextBuffer,0),e.length>=this.hopSize?i.set(e.subarray(0,this.hopSize),this.contextSize):i.set(e,this.contextSize),e.length>=this.contextSize)this.contextBuffer.set(e.subarray(e.length-this.contextSize));else{const d=this.contextSize-e.length;this.contextBuffer.copyWithin(0,e.length),this.contextBuffer.set(e,d)}const a={input:new t.Tensor("float32",i,[1,s]),state:this.stateH,sr:this.srTensor},o=await this.session.run(a),h=o.output.data[0];this.stateH=o.stateN;const u=h>=this.config.threshold;return{probability:h,isSpeech:u,timestamp:Date.now()}}async processBuffer(e){const t=[];for(let s=0;s<e.length;s+=this.hopSize){const i=Math.min(s+this.hopSize,e.length),n=e.subarray(s,i),a=await this.process(n);t.push(a)}return t}reset(){if(!this.initialized)return;const e=typeof ort<"u"?ort:globalThis.ort;this.stateH=new e.Tensor("float32",new Float32Array(256),[2,1,128]),this.contextBuffer.fill(0)}async dispose(){this.session&&(await this.session.release(),this.session=null),this.stateH=null,this.srTensor=null,this.initialized=!1}isReady(){return this.initialized}getHopSize(){return this.hopSize}getConfig(){return{...this.config}}}class $i{config;energyVAD;sileroVAD;state="silence";onsetCounter=0;offsetCounter=0;sileroAccumulator;sileroAccumulatorPos=0;lastSileroProbability=0;sileroReady=!1;constructor(e={}){this.config={sileroThreshold:.5,onsetConfirmations:2,offsetConfirmations:3,sampleRate:16e3,...e},this.energyVAD=new wi(this.config.energyConfig),this.sileroVAD=new Ci({threshold:this.config.sileroThreshold,sampleRate:this.config.sampleRate,...this.config.sileroConfig});const t=this.sileroVAD.getHopSize();this.sileroAccumulator=new Float32Array(t)}async init(e){await this.sileroVAD.init(e),this.sileroReady=!0}async process(e){const t=this.energyVAD.process(e);let s=null;return this.shouldRunSilero(t)&&this.sileroReady&&(s=await this.runSileroOnChunk(e)),this.updateStateMachine(t,s)}shouldRunSilero(e){if(!this.sileroReady)return!1;switch(this.state){case"silence":return e.isSpeech||e.snr!==void 0&&e.snr>1.5;case"speech_candidate":return!0;case"speech_confirmed":return!0;case"speech_ending":return!0;default:return!1}}async runSileroOnChunk(e){let t=null;for(let s=0;s<e.length;s++)this.sileroAccumulator[this.sileroAccumulatorPos++]=e[s],this.sileroAccumulatorPos>=this.sileroAccumulator.length&&(t=await this.sileroVAD.process(this.sileroAccumulator),this.lastSileroProbability=t.probability,this.sileroAccumulatorPos=0);return t}updateStateMachine(e,t,s=!1){this.state;let i=!1,n=!1;const a=t?t.probability>=this.config.sileroThreshold:!1,o=t?.probability??this.lastSileroProbability,c=s||!this.sileroReady;switch(this.state){case"silence":{c?e.isSpeech&&(this.onsetCounter=1,this.state="speech_candidate"):e.isSpeech&&a?(this.onsetCounter=1,this.state="speech_candidate"):e.isSpeech&&t&&!a&&(this.onsetCounter=0);break}case"speech_candidate":{c?e.isSpeech?(this.onsetCounter++,this.onsetCounter>=this.config.onsetConfirmations&&(this.state="speech_confirmed",this.offsetCounter=0,i=!0)):(this.onsetCounter=0,this.state="silence"):a?(this.onsetCounter++,this.onsetCounter>=this.config.onsetConfirmations&&(this.state="speech_confirmed",this.offsetCounter=0,i=!0)):t&&!a?(this.onsetCounter=0,this.state="silence"):e.isSpeech||(this.onsetCounter=0,this.state="silence");break}case"speech_confirmed":{c?e.isSpeech?this.offsetCounter=0:(this.offsetCounter=1,this.state="speech_ending"):t&&!a?(this.offsetCounter=1,this.state="speech_ending"):!e.isSpeech&&!t?(this.offsetCounter=1,this.state="speech_ending"):this.offsetCounter=0;break}case"speech_ending":{c?e.isSpeech?(this.state="speech_confirmed",this.offsetCounter=0):(this.offsetCounter++,this.offsetCounter>=this.config.offsetConfirmations&&(this.state="silence",this.onsetCounter=0,n=!0)):t&&!a?(this.offsetCounter++,this.offsetCounter>=this.config.offsetConfirmations&&(this.state="silence",this.onsetCounter=0,n=!0)):a?(this.state="speech_confirmed",this.offsetCounter=0):!e.isSpeech&&!t&&(this.offsetCounter++,this.offsetCounter>=this.config.offsetConfirmations&&(this.state="silence",this.onsetCounter=0,n=!0));break}}return{isSpeech:this.state==="speech_confirmed"||this.state==="speech_ending",state:this.state,energy:e.energy,sileroProbability:o||void 0,timestamp:Date.now(),speechStart:i,speechEnd:n,snr:e.snr,noiseFloor:e.noiseFloor}}processEnergyOnly(e){const t=this.energyVAD.process(e);return this.updateStateMachine(t,null,!0)}reset(){this.state="silence",this.onsetCounter=0,this.offsetCounter=0,this.sileroAccumulatorPos=0,this.sileroAccumulator.fill(0),this.lastSileroProbability=0,this.energyVAD.reset(),this.sileroReady&&this.sileroVAD.reset()}async dispose(){await this.sileroVAD.dispose(),this.sileroReady=!1}isReady(){return this.sileroReady}getState(){return this.state}getConfig(){return{...this.config}}getLastSileroProbability(){return this.lastSileroProbability}}class _i{worker;messageId=0;pendingPromises=new Map;resultCallback=null;ready=!1;constructor(){this.worker=new Worker(new URL("/keet/assets/tenvad.worker-CO11eRiD.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleMessage(e.data)},this.worker.onerror=e=>{const t=e;console.error("[TenVADWorkerClient] Worker error:",t.message);for(const[,s]of this.pendingPromises)s.reject(new Error(t.message||"TenVAD worker error"));this.pendingPromises.clear()}}async init(e={}){const t={hopSize:e.hopSize??256,threshold:e.threshold??.5,wasmPath:e.wasmPath??"/wasm/"},s=await this.sendRequest("INIT",t);return this.ready=!0,s}onResult(e){this.resultCallback=e}process(e,t){if(!this.ready)return;const s=new Float32Array(e);this.worker.postMessage({type:"PROCESS",payload:{samples:s,globalSampleOffset:t}},[s.buffer])}processTransfer(e,t){this.ready&&this.worker.postMessage({type:"PROCESS",payload:{samples:e,globalSampleOffset:t}},[e.buffer])}async reset(){await this.sendRequest("RESET",void 0)}dispose(){this.worker.terminate();for(const[,e]of this.pendingPromises)e.reject(new Error("TenVADWorkerClient disposed"));this.pendingPromises.clear(),this.ready=!1,this.resultCallback=null}isReady(){return this.ready}handleMessage(e){if(e.type==="RESULT"){this.resultCallback?.(e.payload);return}if(e.type==="ERROR"){const t=this.pendingPromises.get(e.id);t?(this.pendingPromises.delete(e.id),t.reject(new Error(e.payload))):console.error("[TenVADWorkerClient] Unhandled error:",e.payload);return}if(e.id!==void 0){const t=this.pendingPromises.get(e.id);t&&(this.pendingPromises.delete(e.id),t.resolve(e.payload))}}sendRequest(e,t){return new Promise((s,i)=>{const n=++this.messageId;this.pendingPromises.set(n,{resolve:s,reject:i}),this.worker.postMessage({type:e,payload:t,id:n})})}}class Ti{config;ringBuffer;vadBuffer;sentenceEnds=[];matureCursorFrame=0;firstSentenceReceived=!1;constructor(e,t=null,s={}){this.ringBuffer=e,this.vadBuffer=t,this.config={sampleRate:16e3,minDurationSec:3,maxDurationSec:30,minInitialDurationSec:1.5,maxSentences:4,useVadBoundaries:!0,vadSilenceThreshold:.3,debug:!1,...s}}markSentenceEnd(e){this.sentenceEnds.push(e),this.sentenceEnds.length>this.config.maxSentences&&(this.sentenceEnds=this.sentenceEnds.slice(-this.config.maxSentences)),this.firstSentenceReceived||(this.firstSentenceReceived=!0,this.config.debug&&console.log(`[WindowBuilder] First sentence received at frame ${e}`))}advanceMatureCursor(e){if(e>this.matureCursorFrame){const t=this.matureCursorFrame;if(this.matureCursorFrame=e,this.config.debug){const s=e/this.config.sampleRate;console.log(`[WindowBuilder] Cursor advanced from frame ${t} to ${e} (${s.toFixed(2)}s)`)}this.firstSentenceReceived||(this.firstSentenceReceived=!0)}}advanceMatureCursorByTime(e){const t=Math.round(e*this.config.sampleRate);this.advanceMatureCursor(t)}getMatureCursorFrame(){return this.matureCursorFrame}getMatureCursorTime(){return this.matureCursorFrame/this.config.sampleRate}buildWindow(){const e=this.ringBuffer.getCurrentFrame(),t=this.ringBuffer.getBaseFrameOffset();if(e===t)return null;const s=e-t;if(!this.firstSentenceReceived){const h=Math.round(this.config.minInitialDurationSec*this.config.sampleRate);if(s<h){if(this.config.debug){const p=s/this.config.sampleRate;console.log(`[WindowBuilder] Initial mode: waiting (${p.toFixed(2)}s / ${this.config.minInitialDurationSec}s)`)}return null}const u=Math.round(this.config.maxDurationSec*this.config.sampleRate),d=Math.min(e,t+u),m=(d-t)/this.config.sampleRate;return this.config.debug&&console.log(`[WindowBuilder] Initial window [${t}:${d}] (${m.toFixed(2)}s)`),{startFrame:t,endFrame:d,durationSeconds:m,isInitial:!0}}let i;if(this.matureCursorFrame>0?i=this.matureCursorFrame:this.sentenceEnds.length>=2?i=this.sentenceEnds[this.sentenceEnds.length-2]:this.sentenceEnds.length>=1?i=this.sentenceEnds[0]:i=t,i<t&&(this.config.debug&&console.log(`[WindowBuilder] Start frame ${i} < base ${t}; clipping to base.`),i=t),i>=e)return this.config.debug&&console.log("[WindowBuilder] Start frame >= end frame, nothing new to transcribe"),null;let n=e-i;const a=Math.round(this.config.minDurationSec*this.config.sampleRate);if(n<a){if(this.config.debug){const h=n/this.config.sampleRate;console.log(`[WindowBuilder] Insufficient audio (${h.toFixed(2)}s < ${this.config.minDurationSec}s). Waiting...`)}return null}const o=Math.round(this.config.maxDurationSec*this.config.sampleRate);if(n>o){const h=e-o;h<this.matureCursorFrame?i=this.matureCursorFrame:i=h,n=e-i}if(this.config.useVadBoundaries&&this.vadBuffer){const h=Math.min(i+Math.round(this.config.sampleRate*.5),e),u=this.vadBuffer.findSilenceBoundary(h,i,this.config.vadSilenceThreshold);if(u>i){const d=e-u;d/this.config.sampleRate>=this.config.minDurationSec&&(this.config.debug&&console.log(`[WindowBuilder] VAD adjusted start: ${i} -> ${u}`),i=u,n=d)}}if(i>=e)return null;const c=(e-i)/this.config.sampleRate;return this.config.debug&&console.log(`[WindowBuilder] Window [${i}:${e}] duration=${c.toFixed(2)}s cursor=${this.matureCursorFrame}`),{startFrame:i,endFrame:e,durationSeconds:c,isInitial:!1}}getSilenceTailDuration(){return this.vadBuffer?this.vadBuffer.getSilenceTailDuration(this.config.vadSilenceThreshold):0}hasSpeechInPendingWindow(){if(!this.vadBuffer)return!0;const e=this.ringBuffer.getCurrentFrame(),t=this.matureCursorFrame>0?this.matureCursorFrame:this.ringBuffer.getBaseFrameOffset();return t>=e?!1:this.vadBuffer.hasSpeechInRange(t,e,this.config.vadSilenceThreshold)}reset(){this.sentenceEnds=[],this.matureCursorFrame=0,this.firstSentenceReceived=!1,this.config.debug&&console.log("[WindowBuilder] Reset")}getConfig(){return{...this.config}}}class ki{worker;messageId=0;pendingPromises=new Map;ready=!1;constructor(){this.worker=new Worker(new URL("/keet/assets/buffer.worker-BzGXA4L-.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleMessage(e.data)},this.worker.onerror=e=>{const t=e;console.error("[BufferWorkerClient] Worker error:",t.message);for(const[,s]of this.pendingPromises)s.reject(new Error(t.message||"BufferWorker error"));this.pendingPromises.clear()}}async init(e){await this.sendRequest("INIT",e),this.ready=!0}async reset(){await this.sendRequest("RESET",void 0)}dispose(){this.worker.terminate();for(const[,e]of this.pendingPromises)e.reject(new Error("BufferWorkerClient disposed"));this.pendingPromises.clear(),this.ready=!1}writeScalar(e,t){this.ready&&this.worker.postMessage({type:"WRITE",payload:{layer:e,data:[t]}})}writeEntry(e,t){if(!this.ready)return;const s=new Float32Array(t);this.worker.postMessage({type:"WRITE",payload:{layer:e,data:s}},[s.buffer])}writeBatch(e,t,s){if(!this.ready)return;const i=new Float32Array(t);this.worker.postMessage({type:"WRITE_BATCH",payload:{layer:e,data:i,globalSampleOffset:s}},[i.buffer])}writeBatchTransfer(e,t,s){this.ready&&this.worker.postMessage({type:"WRITE_BATCH",payload:{layer:e,data:t,globalSampleOffset:s}},[t.buffer])}writeAudio(e){if(!this.ready)return;const t=new Float32Array(e);this.worker.postMessage({type:"WRITE_BATCH",payload:{layer:"audio",data:t}},[t.buffer])}async hasSpeech(e,t,s,i){return this.sendRequest("HAS_SPEECH",{layer:e,startSample:t,endSample:s,threshold:i})}async getSilenceTailDuration(e,t){return(await this.sendRequest("GET_SILENCE_TAIL",{layer:e,threshold:t})).durationSec}async queryRange(e,t,s){return this.sendRequest("QUERY_RANGE",{startSample:e,endSample:t,layers:s})}async getState(){return this.sendRequest("GET_STATE",void 0)}handleMessage(e){if(e.type==="ERROR"){const t=this.pendingPromises.get(e.id);t&&(this.pendingPromises.delete(e.id),t.reject(new Error(e.payload)));return}if(e.id!==void 0){const t=this.pendingPromises.get(e.id);t&&(this.pendingPromises.delete(e.id),t.resolve(e.payload))}}sendRequest(e,t){return new Promise((s,i)=>{const n=++this.messageId;this.pendingPromises.set(n,{resolve:s,reject:i}),this.worker.postMessage({type:e,payload:t,id:n})})}}function Ei(r){const e=Math.floor(r/3600),t=Math.floor(r%3600/60),s=r%60;return`${e>0?e.toString().padStart(2,"0")+":":""}${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}var Mi=$('<header class="h-20 flex items-center justify-between px-8 bg-[var(--color-earthy-bg)]/80 backdrop-blur-sm z-30 shrink-0"><div class="flex items-center gap-6"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-[var(--color-earthy-muted-green)] flex items-center justify-center text-white"><span class="material-symbols-outlined text-xl">auto_awesome</span></div><div><h1 class="text-lg font-semibold tracking-tight text-[var(--color-earthy-dark-brown)]">keet</h1><p class="text-[10px] uppercase tracking-[0.2em] text-[var(--color-earthy-soft-brown)] font-medium"></p></div></div></div><div class="flex items-center gap-4"><button type=button aria-label="Toggle debug panel"><span class=material-symbols-outlined>bug_report</span></button><button type=button class="p-2 text-[var(--color-earthy-muted-green)] hover:scale-110 transition-transform"aria-label="More options"><span class=material-symbols-outlined>more_vert'),Ri=$('<div class="flex items-center gap-2 px-1"><div class="flex-1 h-1.5 rounded-full overflow-hidden bg-[var(--color-earthy-sage)]/20"><div class="h-full bg-[var(--color-earthy-muted-green)] rounded-full transition-all duration-300"></div></div><span class="text-[10px] font-mono text-[var(--color-earthy-soft-brown)] tabular-nums">%'),Fi=$('<span class="material-symbols-outlined load-btn-spin">progress_activity'),Ai=$('<div class="absolute bottom-0 left-0 right-0 z-20 flex flex-col bg-[var(--color-earthy-bg)] border-t border-[var(--color-earthy-sage)]/30 shadow-[0_-4px_20px_rgba(0,0,0,0.08)] max-h-[70vh] overflow-hidden transition-all">'),Di=$('<div class="h-screen flex flex-col overflow-hidden bg-[var(--color-earthy-bg)] selection:bg-[var(--color-earthy-coral)] selection:text-white"><div class="flex-1 flex overflow-hidden relative"><main class="flex-1 overflow-y-auto custom-scrollbar px-6 flex flex-col items-center"><div class="max-w-3xl w-full py-12 lg:py-20"></div></main></div><div><div class=relative><div class="absolute left-0 right-0 overflow-hidden transition-[max-height] duration-300 ease-out border border-[var(--color-earthy-sage)]/30 bg-[var(--color-earthy-bg)]/95 backdrop-blur-sm shadow-lg"><div class="max-h-[70vh] min-h-0 flex flex-col overflow-y-auto custom-scrollbar"></div></div><div class="bg-white/90 backdrop-blur-md shadow-lg border border-[var(--color-earthy-sage)]/30 rounded-2xl overflow-hidden"role=presentation><div class="p-4 flex items-center justify-between gap-6 cursor-grab active:cursor-grabbing"><div class="flex items-center gap-2 flex-shrink-0"><span class="material-symbols-outlined text-[var(--color-earthy-soft-brown)] text-lg opacity-60"aria-hidden=true>drag_indicator</span><div class="flex flex-col min-w-[60px]"><span class="text-[10px] uppercase tracking-wider text-[var(--color-earthy-soft-brown)] font-bold">Rec</span><span class="font-mono text-sm text-[var(--color-earthy-dark-brown)]"></span></div></div><div class="flex-1 min-w-0 flex flex-col justify-center gap-1"><div class="h-8 flex items-center justify-center gap-1 overflow-hidden opacity-80 abstract-wave"></div></div><div class="flex items-center gap-2 flex-shrink-0"><button type=button><span class=material-symbols-outlined>mic</span></button><button type=button class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] transition-colors border border-transparent hover:border-[var(--color-earthy-sage)]/30 disabled:opacity-40 disabled:cursor-not-allowed relative"></button><button type=button title=Settings><span class=material-symbols-outlined>tune</span></button><button type=button class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] transition-colors border border-transparent hover:border-[var(--color-earthy-sage)]/30 disabled:opacity-40 disabled:cursor-not-allowed"title=Pause><span class=material-symbols-outlined>pause</span></button><button type=button class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] transition-colors border border-transparent hover:border-[var(--color-earthy-sage)]/30"title="Copy transcript"><span class=material-symbols-outlined>content_copy'),Ii=$("<span class=material-symbols-outlined>power_settings_new");let ne=null;const[jt,Pi]=M(null);let re=null,de=null;const[Li,ot]=M(null);let _t=null,Tt=null,kt=null,at,lt=null,ve=null,Ae=null,Me=null,ct,dt=!1,ht=null,ut=null,Ze=!1,Et=0,Ke=0,Mt=null,Rt=!1,Ne=null,Ft=!1;const Bi=r=>{Mt=r,!Rt&&(Rt=!0,requestAnimationFrame(()=>{if(Rt=!1,Mt===null)return;const e=l.vadState();l.setVadState({...e,sileroProbability:Mt})}))},zi=r=>{Ne=r,!Ft&&(Ft=!0,requestAnimationFrame(()=>{if(Ft=!1,!Ne)return;const e=l.vadState(),t=Ne.sileroProbability!==void 0?Ne.sileroProbability:e.sileroProbability;l.setVadState({...e,...Ne,sileroProbability:t}),l.setIsSpeechDetected(Ne.isSpeech),Ne=null}))},Vi=r=>{const e=()=>l.modelState()==="ready"?sr(l.selectedModelId()):"Session";return(()=>{var t=Mi(),s=t.firstChild,i=s.firstChild,n=i.firstChild,a=n.nextSibling,o=a.firstChild,c=o.nextSibling,h=s.nextSibling,u=h.firstChild;return f(c,e),tr(u,"click",r.onToggleDebug),ee(d=>{var m=`p-2 rounded-full transition-colors ${l.showDebugPanel()?"bg-[var(--color-earthy-muted-green)] text-white":"text-[var(--color-earthy-muted-green)] hover:bg-[var(--color-earthy-sage)]/30"}`,p=l.showDebugPanel()?"Hide debug panel":"Show debug panel";return m!==d.e&&oe(u,d.e=m),p!==d.t&&qe(u,"title",d.t=p),d},{e:void 0,t:void 0}),t})()},qt="boncukjs-control-widget-pos",Gt=672,Ni=80,Oi=()=>{const[r,e]=M(!1),[t,s]=M(!1),[i,n]=M("full");let a;const[o,c]=M(!1),[h,u]=M(null),[d,m]=M(!1),p=()=>l.recordingState()==="recording",k=()=>l.modelState()==="ready";let _={x:0,y:0},E={x:0,y:0};const[x,S]=M(typeof window<"u"?window.innerHeight:600),y=()=>{const v=h();return v?v.y>=x()/2:!0},z=v=>{if(v.target.closest("button, select, input"))return;v.preventDefault();const T=h();if(!T)return;m(!0),_={x:v.clientX,y:v.clientY},E={...T};const j=w=>{const q=w.clientX-_.x,I=w.clientY-_.y,B=typeof window<"u"?window.innerWidth:800,A=typeof window<"u"?window.innerHeight:600,te=Math.max(0,Math.min(B-Gt,E.x+q)),O=Math.max(0,Math.min(A-Ni,E.y+I));u({x:te,y:O})},b=()=>{m(!1),window.removeEventListener("mousemove",j),window.removeEventListener("mouseup",b);const w=h();if(w&&typeof localStorage<"u")try{localStorage.setItem(qt,JSON.stringify(w))}catch{}};window.addEventListener("mousemove",j),window.addEventListener("mouseup",b)};Qe(()=>{if(!t())return;const v=T=>{T.key==="Escape"&&(T.preventDefault(),s(!1))};return document.addEventListener("keydown",v),()=>document.removeEventListener("keydown",v)}),Qe(()=>{l.modelState()==="ready"&&t()&&i()==="model"&&s(!1)}),bt(()=>{const v=()=>S(window.innerHeight);window.addEventListener("resize",v);const T=typeof localStorage<"u"?localStorage.getItem(qt):null;let j=!1;if(T)try{const b=JSON.parse(T);Number.isFinite(b.x)&&Number.isFinite(b.y)&&(u({x:b.x,y:b.y}),j=!0)}catch{}if(!j){const b=window.innerWidth,w=window.innerHeight;u({x:Math.max(0,(b-Gt)/2),y:w-140})}return re=new xi,re.onModelProgress=b=>{l.setModelProgress(b.progress),l.setModelMessage(b.message||""),b.file&&l.setModelFile(b.file)},re.onModelStateChange=b=>{l.setModelState(b)},re.onV3Confirmed=b=>{l.setTranscript(b)},re.onV3Pending=b=>{l.setPendingText(b)},re.onError=b=>{l.setErrorMessage(b)},l.refreshDevices(),c(!0),()=>window.removeEventListener("resize",v)}),Oe(()=>{clearTimeout(a),at?.(),J(),de?.dispose(),re?.dispose()});let R=0,G=!1;const X=async()=>{if(!re||!Me||!ne||!ve||Ze)return;if(l.modelState()!=="ready"){G||(console.log("[v4Tick] Model not ready yet - audio is being captured and preprocessed"),G=!0);return}G&&(console.log("[v4Tick] Model is now ready - starting inference"),G=!1,await re.initV4Service({debug:!1})),R++;const v=performance.now(),T=Math.max(200,l.v4InferenceIntervalMs()-100);if(v-Et<T)return;const j=Me.getMatureCursorFrame(),b=Ke,w=j>0?j:0;let q=!1;if(b>w){const B=await ve.hasSpeech("energyVad",w,b,.3);if(Ae?.isReady()){const A=await ve.hasSpeech("inferenceVad",w,b,.5);q=B.hasSpeech&&A.hasSpeech}else q=B.hasSpeech}if(R<=5||R%20===0){const B=l.vadState(),A=ne.getRingBuffer(),te=A.getCurrentFrame(),O=A.getBaseFrameOffset();console.log(`[v4Tick #${R}] hasSpeech=${q}, vadState=${B.hybridState}, energy=${B.energy.toFixed(4)}, inferenceVAD=${(B.sileroProbability||0).toFixed(2)}, samples=[${w}:${b}], ringBuf=[base=${O}, head=${te}, avail=${te-O}]`)}if(R%40===0&&ve)try{const B=await ve.getState(),A=Object.entries(B.layers).map(([te,O])=>`${te}:${O.fillCount}/${O.maxEntries}@${O.currentSample}`).join(", ");console.log(`[v4Tick #${R}] BufferState: ${A}`)}catch{}if(!q){if(await ve.getSilenceTailDuration("energyVad",.3)>=l.v4SilenceFlushSec())try{const A=await re.v4FinalizeTimeout();A&&(l.setMatureText(A.matureText),l.setImmatureText(A.immatureText),l.setMatureCursorTime(A.matureCursorTime),l.setTranscript(A.fullText),Me.advanceMatureCursorByTime(A.matureCursorTime))}catch(A){console.error("[v4Tick] Flush error:",A)}return}const I=Me.buildWindow();if(!I){if(R<=10||R%20===0){const B=ne.getRingBuffer(),A=B.getCurrentFrame(),te=B.getBaseFrameOffset();console.log(`[v4Tick #${R}] buildWindow=null, ringBuf=[base=${te}, head=${A}, avail=${A-te}], cursor=${Me.getMatureCursorFrame()}`)}return}console.log(`[v4Tick #${R}] Window [${I.startFrame}:${I.endFrame}] ${I.durationSeconds.toFixed(2)}s (initial=${I.isInitial})`),Ze=!0,Et=v;try{const B=performance.now();let A=null;if(de&&(A=await de.getFeatures(I.startFrame,I.endFrame)),!A){Ze=!1;return}const te=I.startFrame/16e3,O=Me.getMatureCursorFrame(),ue=O>0?(I.startFrame-O)/16e3:0,V=await re.processV4ChunkWithFeatures({features:A.features,T:A.T,melBins:A.melBins,timeOffset:te,endTime:I.endFrame/16e3,segmentId:`v4_${Date.now()}`,incrementalCache:ue>0?{cacheKey:"v4-stream",prefixSeconds:ue}:void 0}),Se=performance.now()-B;l.setMatureText(V.matureText),l.setImmatureText(V.immatureText),l.setTranscript(V.fullText),l.setPendingText(V.immatureText),l.setInferenceLatency(Se);const ke=I.durationSeconds*1e3;l.setRtf(Se/ke),V.matureCursorTime>Me.getMatureCursorTime()&&(l.setMatureCursorTime(V.matureCursorTime),Me.advanceMatureCursorByTime(V.matureCursorTime),Me.markSentenceEnd(Math.round(V.matureCursorTime*16e3))),l.setV4MergerStats({sentencesFinalized:V.matureSentenceCount,cursorUpdates:V.stats?.matureCursorUpdates||0,utterancesProcessed:V.stats?.utterancesProcessed||0});const _e=ne.getRingBuffer();l.setBufferMetrics({fillRatio:_e.getFillCount()/_e.getSize(),latencyMs:_e.getFillCount()/16e3*1e3}),V.metrics&&l.setSystemMetrics({throughput:0,modelConfidence:0})}catch(B){console.error("[v4Tick] Inference error:",B)}finally{Ze=!1}},J=()=>{dt=!1,ct&&(clearTimeout(ct),ct=void 0),ht&&(ht(),ht=null),ut&&(ut(),ut=null),lt=null,Ae&&(Ae.dispose(),Ae=null),ve&&(ve.dispose(),ve=null),Me=null,Ze=!1,Et=0,Ke=0},ce=async()=>{if(p()){at?.(),at=void 0,l.stopRecording(),l.setAudioLevel(0),l.setBarLevels(new Float32Array(0));try{if(ne?.stop(),_t&&_t(),Tt&&Tt(),kt&&kt(),J(),re){const v=await re.finalize();let T="";"text"in v&&typeof v.text=="string"?T=v.text:"fullText"in v&&typeof v.fullText=="string"&&(T=v.fullText),l.setTranscript(T),l.setPendingText("")}de?.reset(),ne?.reset()}catch(v){console.warn("[App] Error during stop recording cleanup:",v)}}else try{ne?(ne.updateConfig({deviceId:l.selectedDeviceId()}),ne.reset()):(ne=new Si({sampleRate:16e3,deviceId:l.selectedDeviceId()}),Pi(ne));const v=l.transcriptionMode();if(v==="v4-utterance"){k()&&re&&await re.initV4Service({debug:!1}),de||(de=new Ht,ot(de));try{await de.init({nMels:128})}catch{de.dispose(),de=null,ot(null)}ve=new ki;const T={sampleRate:16e3,layers:{audio:{hopSamples:1,entryDimension:1,maxDurationSec:120},mel:{hopSamples:160,entryDimension:128,maxDurationSec:120},energyVad:{hopSamples:1280,entryDimension:1,maxDurationSec:120},inferenceVad:{hopSamples:256,entryDimension:1,maxDurationSec:120}}};await ve.init(T),Ae=new _i,Ae.onResult(w=>{if(ve&&w.hopCount>0){const q=w.probabilities[w.hopCount-1];ve.writeBatchTransfer?ve.writeBatchTransfer("inferenceVad",w.probabilities,w.globalSampleOffset):ve.writeBatch("inferenceVad",w.probabilities,w.globalSampleOffset),Bi(q)}}),Ae.init({hopSize:256,threshold:.5,wasmPath:"/keet/wasm/"}).catch(w=>{console.warn("[v4] TEN-VAD init failed, using energy-only:",w)}),lt=new $i({sileroThreshold:.5,onsetConfirmations:2,offsetConfirmations:3,sampleRate:16e3}),Ke=0,ut=null,ht=ne.onAudioChunk(w=>{if(!lt||!ve)return;const q=Ke;Ke+=w.length;const I=lt.processEnergyOnly(w),B=I.isSpeech?.9:.1;ve.writeScalar("energyVad",B),de?.pushAudioCopy(w),Ae?.isReady()&&Ae.processTransfer(w,q);const A=Ae?.isReady()?void 0:I.sileroProbability||0;zi({isSpeech:I.isSpeech,energy:I.energy,snr:I.snr||0,hybridState:I.state,...A!==void 0?{sileroProbability:A}:{}})}),dt=!0;const b=()=>{dt&&(ct=window.setTimeout(async()=>{dt&&(await X(),b())},l.v4InferenceIntervalMs()))};b()}else if(k()&&re)if(v==="v3-streaming"){const T=l.streamingWindow(),j=l.triggerInterval(),b=Math.max(1,T-j);await re.initV3Service({windowDuration:T,overlapDuration:b,sampleRate:16e3,frameStride:l.frameStride()}),de||(de=new Ht,ot(de));try{await de.init({nMels:128})}catch{de.dispose(),de=null,ot(null)}kt=ne.onAudioChunk(w=>{de?.pushAudioCopy(w)}),Tt=ne.onWindowChunk(T,b,j,async(w,q)=>{if(!re)return;const I=performance.now();let B;if(de){const O=Math.round(q*16e3),ue=O+w.length,V=await de.getFeatures(O,ue);V?B=await re.processV3ChunkWithFeatures(V.features,V.T,V.melBins,q,b):B=await re.processV3Chunk(w,q)}else B=await re.processV3Chunk(w,q);const A=performance.now()-I,te=l.triggerInterval();if(l.setRtf(A/(te*1e3)),l.setInferenceLatency(A),ne){const O=ne.getRingBuffer();l.setBufferMetrics({fillRatio:O.getFillCount()/O.getSize(),latencyMs:O.getFillCount()/16e3*1e3})}l.setMergeInfo({lcsLength:B.lcsLength,anchorValid:B.anchorValid,chunkCount:B.chunkCount,anchorTokens:B.anchorTokens})})}else await re.initService({sampleRate:16e3}),_t=ne.onSpeechSegment(async T=>{if(re){const j=Date.now(),b=ne.getRingBuffer().read(T.startFrame,T.endFrame),w=await re.transcribeSegment(b);w.text&&l.appendTranscript(w.text+" "),l.setInferenceLatency(Date.now()-j)}});await ne.start(),v==="v4-utterance"&&(Me=new Ti(ne.getRingBuffer(),null,{sampleRate:16e3,minDurationSec:3,maxDurationSec:30,minInitialDurationSec:1.5,useVadBoundaries:!1,vadSilenceThreshold:.3,debug:!0})),l.startRecording(),at=ne.onVisualizationUpdate((T,j)=>{l.setAudioLevel(j.currentEnergy),l.transcriptionMode()!=="v4-utterance"&&l.setIsSpeechDetected(ne?.isSpeechActive()??!1),l.setBarLevels(ne.getBarLevels())})}catch(v){l.setErrorMessage(v.message)}},ge=async()=>{if(re&&l.modelState()!=="ready"&&l.modelState()!=="loading"){s(!0);try{await re.initModel(l.selectedModelId())}catch(v){console.error("Failed to load model:",v),l.setModelState("error"),l.setErrorMessage(v instanceof Error?v.message:String(v))}}},ye=()=>{clearTimeout(a),n("audio"),s(!0)},C=()=>{clearTimeout(a),n("model"),s(!0)},P=()=>{a=window.setTimeout(()=>{i()!=="full"&&l.modelState()!=="loading"&&s(!1)},250)},L=()=>clearTimeout(a),H=()=>{i()!=="full"&&P()},Q=async v=>{if(re){s(!0);try{await re.initLocalModel(v)}catch(T){console.error("Failed to load local model:",T)}}};return(()=>{var v=Di(),T=v.firstChild,j=T.firstChild,b=j.firstChild,w=T.nextSibling,q=w.firstChild,I=q.firstChild,B=I.firstChild,A=I.nextSibling,te=A.firstChild,O=te.firstChild,ue=O.firstChild,V=ue.nextSibling,Se=V.firstChild,ke=Se.nextSibling,_e=O.nextSibling,We=_e.firstChild,ze=_e.nextSibling,Re=ze.firstChild,xe=Re.nextSibling,Ve=xe.nextSibling,Fe=Ve.nextSibling,Pe=Fe.nextSibling;return f(v,F(us,{get isVisible(){return r()},get state(){return l.modelState()},get progress(){return l.modelProgress()},get message(){return l.modelMessage()},get file(){return l.modelFile()},get backend(){return l.backend()},get selectedModelId(){return l.selectedModelId()},onModelSelect:g=>l.setSelectedModelId(g),onStart:()=>ge(),onLocalLoad:Q,onClose:()=>e(!1)}),T),f(v,F(Vi,{onToggleDebug:()=>l.setShowDebugPanel(!l.showDebugPanel())}),T),f(b,F(Jr,{get confirmedText(){return Te(()=>l.transcriptionMode()==="v4-utterance")()?l.matureText():l.transcript()},get pendingText(){return Te(()=>l.transcriptionMode()==="v4-utterance")()?l.immatureText():l.pendingText()},get isRecording(){return p()},get lcsLength(){return l.mergeInfo().lcsLength},get anchorValid(){return l.mergeInfo().anchorValid},get showConfidence(){return l.transcriptionMode()==="v3-streaming"},class:"min-h-[40vh]"})),I.addEventListener("mouseleave",H),I.addEventListener("mouseenter",L),f(B,F(Js,{get section(){return i()},onClose:()=>s(!1),onLoadModel:()=>ge(),onLocalLoad:Q,onOpenDebug:()=>l.setShowDebugPanel(!0),onDeviceSelect:g=>{ne&&ne.updateConfig({deviceId:g})},get audioEngine(){return jt()??void 0},expandUp:y})),A.$$mousedown=z,f(ke,()=>Ei(l.sessionDuration())),f(We,F(rs,{get audioLevel(){return l.audioLevel()},get barLevels(){return l.barLevels()},get isRecording(){return p()}})),f(_e,F(Z,{get when(){return l.modelState()==="loading"},get children(){var g=Ri(),N=g.firstChild,D=N.firstChild,W=N.nextSibling,U=W.firstChild;return f(W,()=>Math.round(l.modelProgress()),U),ee(Y=>Ce(D,"width",`${Math.max(0,Math.min(100,l.modelProgress()))}%`)),g}}),null),Re.addEventListener("mouseleave",P),Re.addEventListener("mouseenter",ye),Re.$$click=ce,xe.addEventListener("mouseleave",P),xe.addEventListener("mouseenter",C),xe.$$click=()=>ge(),f(xe,F(Z,{get when(){return l.modelState()==="loading"},get fallback(){return Ii()},get children(){return Fi()}})),Ve.$$click=()=>{n("full"),s(g=>!g)},Fe.$$click=()=>p()&&ce(),Pe.$$click=()=>l.copyTranscript(),f(v,F(Z,{get when(){return l.showDebugPanel()},get children(){var g=Ai();return f(g,F(Ns,{get audioEngine(){return jt()??void 0},get melClient(){return Li()??void 0}})),g}}),null),ee(g=>{var N=h()!==null?"fixed z-30 w-full max-w-2xl px-6 select-none":"absolute bottom-8 left-1/2 -translate-x-1/2 z-30 w-full max-w-2xl px-6",D=h()?{left:`${h().x}px`,top:`${h().y}px`}:{},W={"max-h-0":!t(),"max-h-[70vh]":t(),"bottom-full rounded-t-2xl border-b-0":y(),"top-full rounded-b-2xl border-t-0":!y()},U=`w-10 h-10 rounded-full flex items-center justify-center transition-colors border ${p()?"bg-[var(--color-earthy-coral)] text-white border-[var(--color-earthy-coral)]":"text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] border-transparent hover:border-[var(--color-earthy-sage)]/30"}`,Y=p()?"Stop recording":"Start recording",ie=l.modelState()==="loading"||l.modelState()==="ready",ae=l.modelState()==="ready"?"Model loaded":l.modelState()==="loading"?"Loading...":"Load model",K=`w-10 h-10 rounded-full flex items-center justify-center transition-colors border ${t()?"bg-[var(--color-earthy-sage)]/30 text-[var(--color-earthy-muted-green)] border-[var(--color-earthy-sage)]/50":"text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] border-transparent hover:border-[var(--color-earthy-sage)]/30"}`,se=!p();return N!==g.e&&oe(w,g.e=N),g.t=Vr(w,D,g.t),g.a=zr(I,W,g.a),U!==g.o&&oe(Re,g.o=U),Y!==g.i&&qe(Re,"title",g.i=Y),ie!==g.n&&(xe.disabled=g.n=ie),ae!==g.s&&qe(xe,"title",g.s=ae),K!==g.h&&oe(Ve,g.h=K),se!==g.r&&(Fe.disabled=g.r=se),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),v})()};Ge(["click","mousedown"]);const nr=document.getElementById("root");if(!nr)throw new Error("Root element not found");Br(()=>F(Oi,{}),nr);
