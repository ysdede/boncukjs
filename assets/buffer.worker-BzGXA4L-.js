class u{hopSamples;entryDimension;maxEntries;buffer;globalWriteIndex=0;constructor(e,a){this.hopSamples=e.hopSamples,this.entryDimension=e.entryDimension,this.maxEntries=Math.ceil(a*e.maxDurationSec/e.hopSamples),this.buffer=new Float32Array(this.maxEntries*this.entryDimension)}write(e){const a=this.globalWriteIndex%this.maxEntries*this.entryDimension;for(let n=0;n<this.entryDimension;n++)this.buffer[a+n]=e[n]??0;this.globalWriteIndex++}writeBatch(e,a){const n=a??Math.floor(e.length/this.entryDimension);for(let i=0;i<n;i++){const l=this.globalWriteIndex%this.maxEntries*this.entryDimension,r=i*this.entryDimension;for(let h=0;h<this.entryDimension;h++)this.buffer[l+h]=e[r+h]??0;this.globalWriteIndex++}}setGlobalWriteIndex(e){this.globalWriteIndex=e}sampleToEntry(e){return Math.floor(e/this.hopSamples)}entryToSample(e){return e*this.hopSamples}getBaseEntry(){return Math.max(0,this.globalWriteIndex-this.maxEntries)}getCurrentSample(){return this.globalWriteIndex*this.hopSamples}getOldestSample(){return this.getBaseEntry()*this.hopSamples}readRange(e,a){if(a<=e)return null;const n=this.sampleToEntry(e),i=Math.ceil(a/this.hopSamples),l=this.getBaseEntry(),r=Math.max(n,l),h=Math.min(i,this.globalWriteIndex);if(h<=r)return null;const m=h-r,d=new Float32Array(m*this.entryDimension);for(let c=0;c<m;c++){const f=(r+c)%this.maxEntries*this.entryDimension,S=c*this.entryDimension;for(let p=0;p<this.entryDimension;p++)d[S+p]=this.buffer[f+p]}return{data:d,entryCount:m,entryDimension:this.entryDimension,firstEntrySample:r*this.hopSamples,hopSamples:this.hopSamples}}hasSpeechInRange(e,a,n){if(this.entryDimension!==1)return{hasSpeech:!1,maxProb:0,entriesChecked:0};const i=this.sampleToEntry(e),l=Math.ceil(a/this.hopSamples),r=this.getBaseEntry(),h=Math.max(i,r),m=Math.min(l,this.globalWriteIndex);if(m<=h)return{hasSpeech:!1,maxProb:0,entriesChecked:0};let d=0;const c=m-h;for(let f=0;f<c;f++){const S=(h+f)%this.maxEntries,p=this.buffer[S];if(p>d&&(d=p),p>=n)return{hasSpeech:!0,maxProb:p,entriesChecked:f+1}}return{hasSpeech:!1,maxProb:d,entriesChecked:c}}getSilenceTailDuration(e,a){if(this.entryDimension!==1||this.globalWriteIndex===0)return 0;const n=this.getBaseEntry();let i=0;for(let l=this.globalWriteIndex-1;l>=n;l--){const r=l%this.maxEntries;if(this.buffer[r]>=e)break;i++}return i*this.hopSamples/a}getState(){return{globalWriteIndex:this.globalWriteIndex,currentSample:this.getCurrentSample(),oldestSample:this.getOldestSample(),fillCount:Math.min(this.globalWriteIndex,this.maxEntries),maxEntries:this.maxEntries,hopSamples:this.hopSamples,entryDimension:this.entryDimension}}reset(){this.globalWriteIndex=0,this.buffer.fill(0)}}let y=null,s=null;self.onmessage=t=>{const e=t.data;try{switch(e.type){case"INIT":E(e.id,e.payload);break;case"WRITE":g(e.payload);break;case"WRITE_BATCH":b(e.payload);break;case"HAS_SPEECH":x(e.id,e.payload);break;case"GET_SILENCE_TAIL":I(e.id,e.payload);break;case"QUERY_RANGE":R(e.id,e.payload);break;case"GET_STATE":T(e.id);break;case"RESET":W(e.id);break;default:o({type:"ERROR",id:e.id??0,payload:`Unknown message type: ${e.type}`})}}catch(a){o({type:"ERROR",id:e.id??0,payload:String(a)})}};function E(t,e){y=e;const a=["audio","mel","energyVad","inferenceVad"];s={};for(const l of a){const r=e.layers[l];s[l]=new u(r,e.sampleRate)}const n=(s.audio.getState().maxEntries*4/(1024*1024)).toFixed(1),i=(s.mel.getState().maxEntries*s.mel.getState().entryDimension*4/(1024*1024)).toFixed(1);console.log(`[BufferWorker] Initialized: sr=${e.sampleRate}, audio=${n}MB, mel=${i}MB, energyVad hop=${e.layers.energyVad.hopSamples}, inferenceVad hop=${e.layers.inferenceVad.hopSamples}`),o({type:"INIT",id:t,payload:{success:!0}})}function g(t){if(!s)return;const e=s[t.layer];if(!e)return;if(t.globalSampleOffset!==void 0){const n=e.sampleToEntry(t.globalSampleOffset);e.setGlobalWriteIndex(n)}const a=t.data instanceof Float32Array?t.data:new Float32Array(t.data);e.write(a)}function b(t){if(!s)return;const e=s[t.layer];if(e){if(t.globalSampleOffset!==void 0){const a=e.sampleToEntry(t.globalSampleOffset);e.setGlobalWriteIndex(a)}e.writeBatch(t.data)}}function x(t,e){if(!s){o({type:"HAS_SPEECH",id:t,payload:{hasSpeech:!1,maxProb:0,entriesChecked:0}});return}const a=s[e.layer];if(!a){o({type:"HAS_SPEECH",id:t,payload:{hasSpeech:!1,maxProb:0,entriesChecked:0}});return}const n=a.hasSpeechInRange(e.startSample,e.endSample,e.threshold);o({type:"HAS_SPEECH",id:t,payload:n})}function I(t,e){if(!s||!y){o({type:"GET_SILENCE_TAIL",id:t,payload:{durationSec:0}});return}const a=s[e.layer];if(!a){o({type:"GET_SILENCE_TAIL",id:t,payload:{durationSec:0}});return}const n=a.getSilenceTailDuration(e.threshold,y.sampleRate);o({type:"GET_SILENCE_TAIL",id:t,payload:{durationSec:n}})}function R(t,e){if(!s){o({type:"QUERY_RANGE",id:t,payload:{startSample:e.startSample,endSample:e.endSample,layers:{}}});return}const a={startSample:e.startSample,endSample:e.endSample,layers:{}},n=[];for(const i of e.layers){const l=s[i];if(!l)continue;const r=l.readRange(e.startSample,e.endSample);r&&(a.layers[i]=r,n.push(r.data.buffer))}self.postMessage({type:"QUERY_RANGE",id:t,payload:a},n)}function T(t){if(!s||!y){o({type:"ERROR",id:t,payload:"BufferWorker not initialized"});return}const e={sampleRate:y.sampleRate,layers:{audio:s.audio.getState(),mel:s.mel.getState(),energyVad:s.energyVad.getState(),inferenceVad:s.inferenceVad.getState()}};o({type:"GET_STATE",id:t,payload:e})}function W(t){if(s)for(const e of Object.values(s))e.reset();o({type:"RESET",id:t,payload:{success:!0}})}function o(t,e){self.postMessage(t)}
