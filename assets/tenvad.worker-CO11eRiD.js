let e=null,f=0,o=256,w=.5,g=0,P=0,b=0,s=0,d=null,c=0,E=0;self.onmessage=async a=>{const t=a.data;try{switch(t.type){case"INIT":await v(t.id,t.payload);break;case"PROCESS":T(t.payload.samples,t.payload.globalSampleOffset);break;case"RESET":A(t.id);break;case"DISPOSE":U(t.id);break}}catch(p){_({type:"ERROR",id:t.id??0,payload:String(p)})}};async function v(a,t){o=t.hopSize||256,w=t.threshold||.5;const p=t.wasmPath||"/wasm/";try{const l=new URL(p+"ten_vad.js",self.location.origin).href,y=await(await fetch(l)).text(),u=URL.createObjectURL(new Blob([y],{type:"application/javascript"})),{default:m}=await import(u);URL.revokeObjectURL(u),e=await m({locateFile:r=>r.endsWith(".wasm")?new URL(p+r,self.location.origin).href:r}),s=e._malloc(4),g=e._malloc(o*2),P=e._malloc(4),b=e._malloc(4);const n=e._ten_vad_create(s,o,w);if(n!==0)throw new Error(`ten_vad_create failed with code ${n}`);f=e.HEAP32[s>>2];const i=e._ten_vad_get_version(),h=e.UTF8ToString?e.UTF8ToString(i):`ptr@${i}`;d=new Float32Array(o),c=0,E=0,console.log(`[TenVAD Worker] Initialized: hopSize=${o}, threshold=${w}, version=${h}`),_({type:"INIT",id:a,payload:{success:!0,version:h}})}catch(l){console.error("[TenVAD Worker] Init failed:",l),_({type:"ERROR",id:a,payload:`TEN-VAD init failed: ${l}`})}}function T(a,t){if(!e||!f||!d)return;const p=performance.now();let l=t,R=!1;const y=Math.ceil((a.length+c)/o),u=new Float32Array(y),m=new Uint8Array(y);let n=0,i=0;for(;i<a.length;){for(;c<o&&i<a.length;)d[c++]=a[i++];if(c>=o){R||(l=t+i-o,R=!0);for(let r=0;r<o;r++){const S=Math.max(-1,Math.min(1,d[r]));e.HEAP16[(g>>1)+r]=Math.round(S*32767)}e._ten_vad_process(f,g,o,P,b)===0&&(u[n]=e.HEAPF32[P>>2],m[n]=e.HEAP32[b>>2],n++),c=0}}if(E=t+a.length,n>0){const h=u.slice(0,n),r=m.slice(0,n),S={probabilities:h,flags:r,globalSampleOffset:l,hopCount:n,processingTimeMs:performance.now()-p};self.postMessage({type:"RESULT",payload:S},[h.buffer,r.buffer])}}function A(a){d&&(d.fill(0),c=0),E=0,e&&f&&(e._ten_vad_destroy(s),e._ten_vad_create(s,o,w)===0&&(f=e.HEAP32[s>>2])),_({type:"RESET",id:a,payload:{success:!0}})}function U(a){e&&f&&(e._ten_vad_destroy(s),e._free(g),e._free(P),e._free(b),e._free(s)),e=null,f=0,d=null,_({type:"DISPOSE",id:a,payload:{success:!0}})}function _(a,t){self.postMessage(a)}
